#### OT Security Section

[ot_sec_create_cve_joined]
action.email.useNSSubject = 1
action.keyindicator.invert = 0
action.makestreams.param.verbose = 0
action.nbtstat.param.verbose = 0
action.notable.param.verbose = 0
action.nslookup.param.verbose = 0
action.ping.param.verbose = 0
action.risk.param.verbose = 0
action.send2uba.param.verbose = 0
action.threat_add.param.verbose = 0
alert.track = 0
dispatch.earliest_time = 0
display.general.type = statistics
display.page.search.mode = verbose
display.page.search.tab = statistics
display.visualizations.show = 0
request.ui_dispatch_app = cve_lookup
request.ui_dispatch_view = search
search = `ot_vuln_latest(8000)` \
| stats last(_time) as _time, count, values(description.description_data{}.value) as description, last(lastModifiedDate) as lastModifiedDate by cve sourcetype \
| append \
    [ search index=cve sourcetype=cveproducts \
    | eval cve_prod=cve \
    | stats count values(cve_prod) as cve_prod, values(affects.vendor.vendor_data{}.vendor_name) as vendor_product, values(affects.vendor.vendor_data{}.product.product_data{}.product_name) as product_name by cve sourcetype] \
| append \
    [ search index=cve sourcetype=cvereferences\
| stats values(references.reference_data{}.url) as ref_url by cve sourcetype ]\
| stats last(_time) as _time, count, values(sourcetype) as sourcetype, values(cve_prod) as cve_prod, last(lastModifiedDate) as lastModifiedDate, values(vendor_product) as vendor_product, values(product_name) as product_name, values(description) as description, values(ref_url) as ref_url by cve \
| search count>1 ( vendor_product=siemens OR vendor_product="rockwell*" OR vendor_product="hewlett-packard*" OR vendor_product="schneider*" OR vendor_product="mitsubishi*" OR vendor_product="abb*" OR vendor_product="ge *" OR vendor_product="omron*" OR vendor_product="bosch*" OR vendor_product="beckhoff*" OR vendor_product="fuji*" )\
| table _time cve	count	sourcetype	cve_prod	lastModifiedDate	vendor_product	product_name	description	ref_url\
| collect index=cve_sum marker="sum_type=cve_joined"

[Threat - OT Sec - Valid Accounts - Rule]
action.correlationsearch.enabled = 1
action.correlationsearch.label = OT Sec - Valid Accounts
action.customsearchbuilder.enabled = false
action.customsearchbuilder.spec = {}
action.notable = 1
action.notable.param.rule_description = Default account activity detected on critical OT assets - MITRE ICS SECURITY - T859
action.notable.param.rule_title = OT Sec - Valid Accounts
action.notable.param.security_domain = threat
action.notable.param.severity = high
action.notable.param.verbose = 0
action.risk = 1
action.risk.param._risk_object = dvc
action.risk.param._risk_object_type = system
action.risk.param._risk_score = 200
action.risk.param.verbose = 0
alert.suppress = 1
alert.suppress.fields = dvc
alert.suppress.period = 3600s
alert.track = 1
counttype = number of events
cron_schedule = 0 * * * *
description = OT Sec - Valid Accounts
disabled = 1
dispatch.earliest_time = -60m@m
dispatch.latest_time = -0m@m
dispatch.rt_backfill = 1
enableSched = 1
quantity = 0
realtime_schedule = 0
relation = greater than
request.ui_dispatch_app = SplunkEnterpriseSecuritySuite
search = index="notable" ( search_name="* Default Account Activity Detected*" OR search_name="* Default Account At Rest Detected*"  OR search_name="*AAAA*")\
| lookup ot_asset_lookup ip as dest \
| lookup ot_asset_lookup ip as src \
| lookup ot_asset_lookup ip as dvc \
| search asset_type=* asset_criticality=*\
| stats values(asset_criticality) as asset_criticality, values(asset_type) as asset_type, values(category) as category, values(nt_host) as nt_host, values(location) as location, values(vendor_product) as vendor_product, values(hw_model) as hw_model, values(hw_join) as hw_join, count,  latest(_raw) as "orig_raw" by dvc

[Ot_asset - OT Sec - Connection Proxy - Rule]
action.correlationsearch.enabled = 1
action.correlationsearch.label = OT Sec - Connection Proxy
action.customsearchbuilder.enabled = false
action.customsearchbuilder.spec = {}
action.notable = 1
action.notable.param.rule_description = Potential Connection Proxy detected related to critical OT Assets - MITRE ICS SECURITY - T884
action.notable.param.rule_title = OT Sec - Connection Proxy
action.notable.param.security_domain = ot_asset
action.notable.param.severity = high
action.notable.param.verbose = 0
action.risk = 1
action.risk.param.verbose = 0
alert.suppress = 0
alert.track = 1
counttype = number of events
cron_schedule = 0 * * * *
description = T884
disabled = 1
dispatch.earliest_time = -60m@m
dispatch.latest_time = -0m@m
dispatch.rt_backfill = 1
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = SplunkEnterpriseSecuritySuite
search = | tstats `summariesonly` max(_time) as _time,values(All_Traffic.action) as action,values(All_Traffic.src_port) as src_port,count, values(All_Traffic.dest_port) as dest_port_list, values(All_Traffic.transport) as proto_list, sum(All_Traffic.bytes) as sum_bytes from datamodel=Network_Traffic.All_Traffic where * (All_Traffic.dest_port="*" OR All_Traffic.dest_port="SPECIFIC_PORT_IF_NESSASARY" ) by All_Traffic.src, All_Traffic.dest \
| `drop_dm_object_name("All_Traffic")` \
| sort - count \
| fields _time,action,src,src_port,dest,transport,dest_port,count, dest_port_list, proto_list, sum_bytes\
\
| search NOT (src=SRC_WHITELIST_IP_RANGE_OR_HOST OR src=SRC_WHITELIST_IP_RANGE_OR_HOST OR src=SRC_WHITELIST_IP_RANGE_OR_HOST)  (dest=ICS_NET_RANGE OR dest=ICS_NET_RANGE OR dest=ICS_NET_RANGE)\
\
| lookup ot_asset_lookup ip as dest \
| lookup ot_asset_lookup ip as src \
| lookup ot_asset_lookup ip as dvc \
\
| search asset_type=* priority=* \
\
| stats sum(sum_bytes) as traffic_amount, values(priority) as priority, values(asset_type) as asset_type, values(category) as category, values(nt_host) as nt_host, values(location) as location, values(asset_product) as asset_product, values(asset_model) as asset_model, values(hw_join) as hw_join, count,  latest(_raw) as "orig_raw" by dvc\
\
| search traffic_amount< INPUT_THRESH_HOLD_IN_BYTES

[Ot_asset - OT Sec - Data Destruction - Rule]
action.correlationsearch.enabled = 1
action.correlationsearch.label = OT Sec - Data Destruction
action.customsearchbuilder.enabled = false
action.customsearchbuilder.spec = {}
action.notable = 1
action.notable.param.rule_description = Detected suspicious file deletion activities on the endpoint - MITRE ICS ATTACK - T809
action.notable.param.rule_title = OT Sec - Data Destruction
action.notable.param.security_domain = ot_asset
action.notable.param.severity = high
action.notable.param.verbose = 0
action.risk = 1
action.risk.param._risk_object = dvc
action.risk.param._risk_object_type = system
action.risk.param._risk_score = 10
action.risk.param.verbose = 0
alert.suppress = 1
alert.suppress.fields = dvc
alert.suppress.period = 3600s
alert.track = 1
counttype = number of events
cron_schedule = 0 * * * *
description = Using Sysmon event ID 23
disabled = 1
dispatch.earliest_time = -60m@m
dispatch.latest_time = -0m@m
dispatch.rt_backfill = 1
enableSched = 1
quantity = 0
realtime_schedule = 0
relation = greater than
request.ui_dispatch_app = SplunkEnterpriseSecuritySuite
search = sourcetype=sysmon Event 23 File Delete\
| stats values(TargetFilename) as TargetFilename, count, values(Hashes) as Hashes, values(ProcessGuid) as ProcessGuid by host Users \
\
| rename host as dvc\
| lookup ot_asset_lookup ip as dest \
| lookup ot_asset_lookup ip as src \
| lookup ot_asset_lookup ip as dvc \
\
| search asset_type=* priority=* count>5

[Ot_asset - OT Sec - Point & Tag Identification - Rule]
action.correlationsearch.enabled = 1
action.correlationsearch.label = OT Sec - Point & Tag Identification
action.customsearchbuilder.enabled = false
action.customsearchbuilder.spec = {}
action.notable = 1
action.notable.param.rule_description = Potential access of Point & Tag information from non-whitelisted host - MITRE ICS SECURITY - T861
action.notable.param.rule_title = OT Sec - Point & Tag Identification
action.notable.param.security_domain = ot_asset
action.notable.param.severity = high
action.notable.param.verbose = 0
action.risk = 1
action.risk.param._risk_object = dest
action.risk.param._risk_object_type = system
action.risk.param._risk_score = 10
action.risk.param.verbose = 0
alert.suppress = 1
alert.suppress.fields = dvc
alert.suppress.period = 3600s
alert.track = 1
counttype = number of events
cron_schedule = 0 * * * *
disabled = 1
dispatch.earliest_time = -60m@m
dispatch.latest_time = now
dispatch.rt_backfill = 1
enableSched = 1
quantity = 0
realtime_schedule = 0
relation = greater than
request.ui_dispatch_app = SplunkEnterpriseSecuritySuite
schedule_window = 60
search = | tstats `summariesonly` max(_time) as _time,values(All_Traffic.action) as action,values(All_Traffic.src_port) as src_port,count, values(All_Traffic.dest_port) as dest_port_list, values(All_Traffic.transport) as proto_list, sum(All_Traffic.bytes) as sum_bytes from datamodel=Network_Traffic.All_Traffic where * (All_Traffic.dest_port="135" OR All_Traffic.dest_port="1433" OR All_Traffic.dest_port="3306" OR  All_Traffic.dest_port="1521" ) by All_Traffic.src, All_Traffic.dest \
| `drop_dm_object_name("All_Traffic")` \
| sort - count \
| fields _time,action,src,src_port,dest,transport,dest_port,count, dest_port_list, proto_list, sum_bytes\
\
| search NOT (src=SRC_WHITELIST_IP_RANGE OR src=SRC_WHITELIST_IP_RANGE OR src=SRC_WHITELIST_IP_RANGE)  (dest=ICS_NET_RANGE OR dest=ICS_NET_RANGE OR dest=ICS_NET_RANGE)\
\
| lookup ot_asset_lookup ip as dest \
| lookup ot_asset_lookup ip as src \
| lookup ot_asset_lookup ip as dvc \
\
| search (asset_type=Historian OR asset_type="Control Svr" OR asset_type=HMI) priority=* \
\
| stats sum(sum_bytes) as traffic_amount, values(priority) as priority, values(asset_type) as asset_type, values(category) as category, values(nt_host) as nt_host, values(location) as location, values(asset_product) as asset_product, values(asset_model) as asset_model, values(hw_join) as hw_join, count,  latest(_raw) as "orig_raw" by dvc

[Threat - OT Sec - Exploitation of Remote Services - Rule]
action.correlationsearch.enabled = 1
action.correlationsearch.label = OT Sec - Exploitation of Remote Services
action.customsearchbuilder.enabled = false
action.customsearchbuilder.spec = {}
action.notable = 1
action.notable.param.rule_description = Exploitation of Remote Services detected at the endpoint - MITRE ICS SECURITY - T866
action.notable.param.rule_title = OT Sec - Exploitation of Remote Services
action.notable.param.security_domain = ot_asset
action.notable.param.severity = high
action.notable.param.verbose = 0
action.risk = 1
action.risk.param._risk_object = dest
action.risk.param._risk_object_type = system
action.risk.param._risk_score = 100
action.risk.param.verbose = 0
alert.suppress = 1
alert.suppress.fields = dest
alert.suppress.period = 3600s
alert.track = 1
counttype = number of events
cron_schedule = 0 * * * *
description = OT Sec - Exploitation of Remote Services
disabled = 1
dispatch.earliest_time = -60m@m
dispatch.latest_time = -0m@m
dispatch.rt_backfill = 1
enableSched = 1
quantity = 0
realtime_schedule = 0
relation = greater than
request.ui_dispatch_app = SplunkEnterpriseSecuritySuite
search = | tstats `summariesonly` max(_time) as _time,values(All_Traffic.action) as action,values(All_Traffic.src_port) as src_port,count, values(All_Traffic.dest_port) as dest_port_list, values(All_Traffic.transport) as proto_list, sum(All_Traffic.bytes) as sum_bytes from datamodel=Network_Traffic.All_Traffic where * (All_Traffic.dest_port="137" OR All_Traffic.dest_port="138" OR All_Traffic.dest_port="139" ) by All_Traffic.src, All_Traffic.dest \
| `drop_dm_object_name("All_Traffic")` \
| sort - count \
| fields _time,action,src,src_port,dest,transport,dest_port,count, dest_port_list, proto_list, sum_bytes\
| lookup ot_asset_lookup ip as dest \
| lookup ot_asset_lookup ip as src \
| lookup ot_asset_lookup ip as dvc \
| search asset_type=* priority=*\
| stats sum(sum_bytes) as traffic_amount, values(priority) as priority, values(asset_type) as asset_type, values(category) as category, values(nt_host) as nt_host, values(location) as location, values(asset_product) as asset_product, values(asset_model) as asset_model, values(hw_join) as hw_join, count,  latest(_raw) as "orig_raw" by dvc

[Threat - OT Sec - Graphical User Interface - Rule]
action.correlationsearch.enabled = 1
action.correlationsearch.label = OT Sec - Graphical User Interface
action.customsearchbuilder.enabled = false
action.customsearchbuilder.spec = {}
action.notable = 1
action.notable.param.next_steps = {"version":1,"data":"1) Check Host for unauthorized app\n2) Remove apps that uses Remote Desktop"}
action.notable.param.rule_description = Potential remote GUI access to critical OT assets - MITRE ICS SECURITY - T823
action.notable.param.rule_title = OT Sec - Graphical User Interface
action.notable.param.security_domain = ot_asset
action.notable.param.severity = high
action.notable.param.verbose = 0
action.risk = 1
action.risk.param._risk_object = dest
action.risk.param._risk_object_type = system
action.risk.param._risk_score = 100
action.risk.param.verbose = 0
alert.suppress = 1
alert.suppress.fields = dest
alert.suppress.period = 3600s
alert.track = 1
counttype = number of events
cron_schedule = 0 * * * *
description = OT Sec - Graphical User Interface
disabled = 1
dispatch.earliest_time = -60m@m
dispatch.latest_time = -0m@m
dispatch.rt_backfill = 1
enableSched = 1
quantity = 0
realtime_schedule = 0
relation = greater than
request.ui_dispatch_app = SplunkEnterpriseSecuritySuite
search = | tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where (Processes.process=*mstsc.exe* OR Processes.process=*teamviewer* OR Processes.process=*vnc* OR Processes.process=*google*desktop* ) by Processes.dest Processes.user Processes.process \
| `security_content_ctime(firstTime)` \
| `security_content_ctime(lastTime)` \
| `drop_dm_object_name(Processes)`\
| lookup ot_asset_lookup ip as dest \
| lookup ot_asset_lookup ip as src \
| lookup ot_asset_lookup ip as dvc \
| search asset_type=* priority=* \
| stats values(priority) as priority, values(asset_type) as asset_type, values(category) as category, values(nt_host) as nt_host, values(location) as location, values(asset_vendor) as asset_vendor, values(asset_model) as asset_model, values(hw_join) as hw_join, count,  latest(_raw) as "orig_raw" by dest

[Threat - OT Sec - Masquerading - Rule]
action.correlationsearch.enabled = 1
action.correlationsearch.label = OT Sec - Masquerading
action.customsearchbuilder.enabled = false
action.customsearchbuilder.spec = {}
action.notable = 1
action.notable.param.rule_description = Common windows process masquerading its id - MITRE ICS SECURITY - T849
action.notable.param.rule_title = OT Sec - Masquerading
action.notable.param.security_domain = threat
action.notable.param.severity = high
action.notable.param.verbose = 0
action.risk = 1
action.risk.param._risk_object = dvc
action.risk.param._risk_object_type = system
action.risk.param._risk_score = 10
action.risk.param.verbose = 0
alert.suppress = 1
alert.suppress.fields = dvc
alert.suppress.period = 3600s
alert.track = 1
counttype = number of events
cron_schedule = 0 * * * *
description = OT Sec - Masquerading - T849
disabled = 1
dispatch.earliest_time = -60m@m
dispatch.latest_time = -0m@m
dispatch.rt_backfill = 1
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = SplunkEnterpriseSecuritySuite
search = sourcetype=”XmlWinEventLog:Microsoft-Windows-Sysmon/Operational” ( Image=*svchost.exe OR Image=SMSS* OR Image=CSRSS.EXE OR Image=WININIT.EXE OR Image=SERVICES.EXE OR Image=LSASS.EXE OR Image=SVCHOST.EXE OR Image=LSM.EXE OR Image=WINLOGON.EXE OR Image=Explorer.exe )\
\
| eval TIME=strftime(_time,"%Y-%m-%d %H:%M") \
| eventstats dc(host) as host_cnt_image by Image\
| stats earliest(TIME) as first_time, values(host) as host, dc(host) as host_cnt, count by Image, Hashes\
| eval RATIO=(host_cnt/host_cnt_image)*100\
| search RATIO<20\
| mvexpand host\
\
| rename host as dvc\
| lookup ot_asset_lookup ip as dest \
| lookup ot_asset_lookup ip as src \
| lookup ot_asset_lookup ip as dvc \
\
| search asset_type=* priority=*

[Threat - OT Sec - Program Upload - Rule]
action.correlationsearch.enabled = 1
action.correlationsearch.label = OT Sec - Program Upload
action.customsearchbuilder.enabled = false
action.customsearchbuilder.spec = {}
action.notable = 1
action.notable.param.rule_description = Potential Program Upload activity to PLC asset type detected - MITRE ICS SECURITY - T866
action.notable.param.rule_title = OT Sec - Program Upload
action.notable.param.security_domain = threat
action.notable.param.severity = high
action.notable.param.verbose = 0
action.risk = 1
action.risk.param._risk_object = dest
action.risk.param._risk_object_type = system
action.risk.param._risk_score = 100
action.risk.param.verbose = 0
alert.suppress = 1
alert.suppress.fields = dest
alert.suppress.period = 3600s
alert.track = 1
counttype = number of events
cron_schedule = 0 * * * *
description = OT Sec - Program Upload
disabled = 1
dispatch.earliest_time = -60m@m
dispatch.latest_time = -0m@m
dispatch.rt_backfill = 1
enableSched = 1
quantity = 0
realtime_schedule = 0
relation = greater than
request.ui_dispatch_app = SplunkEnterpriseSecuritySuite
search = | tstats `summariesonly` max(_time) as _time,values(All_Traffic.action) as action,values(All_Traffic.src_port) as src_port, sum(All_Traffic.bytes) as sum_bytes, count from datamodel=Network_Traffic.All_Traffic where * (All_Traffic.src="*" OR All_Traffic.src_ip="*" OR All_Traffic.src_mac="*" OR All_Traffic.src_translated_ip="*") (All_Traffic.dest="*" OR All_Traffic.dest_ip="*" OR All_Traffic.dest_mac="*" OR All_Traffic.dest_translated_ip="*") by All_Traffic.src, All_Traffic.dest, All_Traffic.transport, All_Traffic.dest_port \
| `drop_dm_object_name("All_Traffic")` \
| sort - count \
| search sum_bytes>100000000\
| fields _time,action,src,src_port,dest,transport,dest_port,sum_bytes, count\
| lookup ot_asset_lookup ip as dest \
| lookup ot_asset_lookup ip as src \
| lookup ot_asset_lookup ip as dvc \
| search asset_type=plc asset_criticality=*

[Ot_asset - OT Sec - Drive by Compromise - Rule]
action.correlationsearch.enabled = 1
action.correlationsearch.label = OT Sec - Drive by Compromise
action.customsearchbuilder.enabled = false
action.customsearchbuilder.spec = {}
action.notable = 1
action.notable.param.rule_description = Drive by Compromise detected based on the endpoint activities. MITRE ICS SECURITY -T817
action.notable.param.rule_title = OT Sec - Drive by Compromise
action.notable.param.security_domain = ot_asset
action.notable.param.severity = high
action.notable.param.verbose = 0
action.risk = 1
action.risk.param._risk_object = dvc
action.risk.param._risk_object_type = system
action.risk.param._risk_score = 10
action.risk.param.verbose = 0
alert.suppress = 1
alert.suppress.fields = dvc
alert.suppress.period = 3600s
alert.track = 1
counttype = number of events
cron_schedule = */5 * * * *
description = index="notable" ( search_name="Endpoint - High Or Critical Priority Host With Malware Detected" OR search_name="Prohibited Software On Endpoint" OR search_name="Host With A Recurring Malware Infection" OR search_name="High Or Critical Priority Host With Malware Detected" OR search_name="High Number of Hosts Not Updating Malware Signatures" OR search_name="Host With Old Infection Or Potential Re-Infection" OR search_name=" Prohibited Software On Endpoint" OR search_name=" Host With A Recurring Malware Infection" OR search_name=" High Or Critical Priority Host With Malware Detected" OR search_name=" Host With Old Infection Or Potential Re-Infection" OR search_name=" Basic Malware Outbreak (SSE)" OR search_name=" Endpoint Uncleaned Malware Detection (SSE)" OR search_name=" Multiple Infections on Host (SSE)" OR search_name=" New Local Admin Account (SSE)" OR search_name=" Recurring Infection on Host (SSE)" OR search_name=" User Login with Local Credentials (SSE)" OR search_name=" Disabled Update Service (SSE)" OR search_name=" Hosts Sending To More Destinations Than Normal (SSE)" OR search_name=" Host With Multiple Infections (ES)" OR search_name=" Outbreak Detected (ES)" OR search_name=" Anomalous Audit Trail Activity Detected (ES)" OR search_name=" Default Account Activity Detected (ES)" OR search_name=" Same Error On Many Servers Detected (ES)" OR search_name=" Substantial Increase In Events (ES)" OR search_name=" Suspicious HTTP Redirects" )\
| lookup ot_asset_lookup ip as dest \
| lookup ot_asset_lookup ip as src \
| lookup ot_asset_lookup ip as dvc \
| search asset_type=historian\
| stats last(infection_count) as infection_count, values(asset_criticality) as asset_criticality, values(asset_type) as asset_type, values(category) as category, values(nt_host) as nt_host, values(location) as location, values(vendor_product) as vendor_product, values(hw_model) as hw_model, values(hw_join) as hw_join, count,  latest(_raw) as "orig_raw" by dvc
disabled = 1
dispatch.earliest_time = -5m@m
dispatch.latest_time = -0m@m
dispatch.rt_backfill = 1
enableSched = 1
quantity = 0
realtime_schedule = 0
relation = greater than
request.ui_dispatch_app = SplunkEnterpriseSecuritySuite
schedule_window = auto
search = Potential "Drive by Compromise" due to detected based on the endpoint activities.\
MITRE ICS SECURITY -T817

[Threat - OT Sec - Engineering Workstation Compromise - Rule]
action.correlationsearch.enabled = 1
action.correlationsearch.label = OT Sec - Engineering Workstation Compromise
action.customsearchbuilder.enabled = false
action.customsearchbuilder.spec = {}
action.notable = 1
action.notable.param.next_steps = {"version":1,"data":"1) Contact OT asset owner\n2) Create tickets"}
action.notable.param.rule_description = Potential "Engineering Workstation Compromise" due to detected malware at this endpoint that matches Engineering Workstation Compromise asset. MITRE ICS SECURITY -T818
action.notable.param.rule_title = OT Sec - Engineering Workstation Compromise
action.notable.param.security_domain = ot_asset
action.notable.param.severity = high
action.notable.param.verbose = 0
action.risk = 1
action.risk.param._risk_object = dvc
action.risk.param._risk_object_type = system
action.risk.param._risk_score = 10
action.risk.param.verbose = 0
alert.suppress = 1
alert.suppress.fields = dvc
alert.suppress.period = 3600s
alert.track = 1
counttype = number of events
cron_schedule = */5 * * * *
description = Potential "Engineering Workstation Compromise" due to detected malware at this endpoint that matches Engineering Workstation Compromise asset.   Assets with asset_type="eng_workstation"\
MITRE ICS SECURITY -T818
disabled = 1
dispatch.earliest_time = -5m@m
dispatch.latest_time = -0m@m
dispatch.rt_backfill = 1
enableSched = 1
quantity = 0
realtime_schedule = 0
relation = greater than
request.ui_dispatch_app = DA-ESS-OTSecurity
schedule_window = auto
search = index="notable" ( search_name="Endpoint - High Or Critical Priority Host With Malware Detected" OR search_name="Prohibited Software On Endpoint" OR search_name="Host With A Recurring Malware Infection" OR search_name="High Or Critical Priority Host With Malware Detected" OR search_name="High Number of Hosts Not Updating Malware Signatures" OR search_name="Host With Old Infection Or Potential Re-Infection" OR search_name=" Prohibited Software On Endpoint" OR search_name=" Host With A Recurring Malware Infection" OR search_name=" High Or Critical Priority Host With Malware Detected" OR search_name=" Host With Old Infection Or Potential Re-Infection" OR search_name=" Basic Malware Outbreak (SSE)" OR search_name=" Endpoint Uncleaned Malware Detection (SSE)" OR search_name=" Multiple Infections on Host (SSE)" OR search_name=" New Local Admin Account (SSE)" OR search_name=" Recurring Infection on Host (SSE)" OR search_name=" User Login with Local Credentials (SSE)" OR search_name=" Disabled Update Service (SSE)" OR search_name=" Hosts Sending To More Destinations Than Normal (SSE)" OR search_name=" Host With Multiple Infections (ES)" OR search_name=" Outbreak Detected (ES)" OR search_name=" Anomalous Audit Trail Activity Detected (ES)" OR search_name=" Default Account Activity Detected (ES)" OR search_name=" Same Error On Many Servers Detected (ES)" OR search_name=" Substantial Increase In Events (ES)" OR search_name=" Suspicious HTTP Redirects" )\
\
| lookup ot_asset_lookup ip as dest \
| lookup ot_asset_lookup ip as src \
| lookup ot_asset_lookup ip as dvc \
| search asset_type=eng_workstation\
\
| stats last(infection_count) as infection_count, values(asset_criticality) as asset_criticality, values(asset_type) as asset_type, values(category) as category, values(nt_host) as nt_host, values(location) as location, values(vendor_product) as vendor_product, values(hw_model) as hw_model, values(hw_join) as hw_join, count,  latest(_raw) as "orig_raw" by dvc

[Threat - OT Sec - Exploit Public-Facing Application - Rule]
action.correlationsearch.enabled = 1
action.correlationsearch.label = OT Sec - Exploit Public-Facing Application
action.customsearchbuilder.enabled = false
action.customsearchbuilder.spec = {}
action.notable = 1
action.notable.param.next_steps = {"version":1,"data":"1) Check traffic sessions"}
action.notable.param.rule_description = Potential public facing application detected though network traffic sessions out from outside network. MITRE ICS SECURITY -T819
action.notable.param.rule_title = OT Sec - Exploit Public-Facing Application
action.notable.param.security_domain = threat
action.notable.param.severity = medium
action.notable.param.verbose = 0
action.risk = 1
action.risk.param._risk_object = dest_ip
action.risk.param._risk_object_type = system
action.risk.param._risk_score = 100
action.risk.param.verbose = 0
alert.suppress = 1
alert.suppress.fields = dest_ip
alert.suppress.period = 60s
alert.track = 1
counttype = number of events
cron_schedule = 0 * * * *
disabled = 1
dispatch.earliest_time = -60m@m
dispatch.latest_time = -0m@m
dispatch.rt_backfill = 1
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = DA-ESS-OTSecurity
search = index="notable" ( \
search_name="Excessive HTTP Failure Responses"\
OR search_name="Abnormally High Number of HTTP Method Events By Src" )\
\
| rename host as dvc\
| lookup ot_asset_lookup ip as dest \
| lookup ot_asset_lookup ip as src \
| lookup ot_asset_lookup ip as dvc\
\
| search asset_type=”eng* workstation*” priority=*\
\
| stats last(infection_count) as infection_count, values(asset_criticality) as asset_criticality, values(asset_type) as asset_type, values(category) as category, values(nt_host) as nt_host, values(location) as location, values(vendor_product) as vendor_product, values(hw_model) as hw_model, values(hw_join) as hw_join, count,  latest(_raw) as "orig_raw" by dvc\


[Threat - OT Sec - External Remote Services - Rule]
action.correlationsearch.enabled = 1
action.correlationsearch.label = OT Sec - External Remote Services
action.customsearchbuilder.enabled = false
action.customsearchbuilder.spec = {}
action.notable = 1
action.notable.param.rule_description = External Remote Services like SMB, RDP, VNC detected from VPN remote services on OT assets - MITRE ICS SECURITY -  T822
action.notable.param.rule_title = OT Sec - External Remote Services
action.notable.param.security_domain = ot_asset
action.notable.param.severity = high
action.notable.param.verbose = 0
action.risk = 1
action.risk.param._risk_object = dest
action.risk.param._risk_object_type = system
action.risk.param._risk_score = 100
action.risk.param.verbose = 0
alert.suppress = 1
alert.suppress.fields = dest
alert.suppress.period = 3600s
alert.track = 1
counttype = number of events
cron_schedule = 0 * * * *
description = OT Sec - External Remote Services
disabled = 1
dispatch.earliest_time = -60m@m
dispatch.latest_time = -0m@m
dispatch.rt_backfill = 1
enableSched = 1
quantity = 0
realtime_schedule = 0
relation = greater than
request.ui_dispatch_app = SplunkEnterpriseSecuritySuite
search = index="notable" ( \
search_name="Excessive HTTP Failure Responses"\
OR search_name="Abnormally High Number of HTTP Method Events By Src" )\
\
| rename host as dvc\
| lookup ot_asset_lookup ip as dest \
| lookup ot_asset_lookup ip as src \
| lookup ot_asset_lookup ip as dvc\
\
| search ( asset_type=”control server*” OR asset_type=”IO server*”)  priority=*\
\
| stats last(infection_count) as infection_count, values(asset_criticality) as asset_criticality, values(asset_type) as asset_type, values(category) as category, values(nt_host) as nt_host, values(location) as location, values(vendor_product) as vendor_product, values(hw_model) as hw_model, values(hw_join) as hw_join, count,  latest(_raw) as "orig_raw" by dvc\


[Threat - OT Sec - Internet Accessible Device - Rule]
action.correlationsearch.enabled = 1
action.correlationsearch.label = OT Sec - Internet Accessible Device
action.customsearchbuilder.enabled = false
action.customsearchbuilder.spec = {}
action.notable = 1
action.notable.param.rule_description = Potential VPN host direct connection to OT assets - MITRE ICS SECURITY -T883
action.notable.param.rule_title = OT Sec - Internet Accessible Device
action.notable.param.security_domain = threat
action.notable.param.severity = high
action.notable.param.verbose = 0
action.risk = 1
action.risk.param._risk_object = dest
action.risk.param._risk_object_type = system
action.risk.param._risk_score = 100
action.risk.param.verbose = 0
alert.suppress = 1
alert.suppress.fields = dest
alert.suppress.period = 3600s
alert.track = 1
counttype = number of events
cron_schedule = */10 * * * *
description = OT Sec - Internet Accessible Device.\
Setup : Must define outside network as "src"
disabled = 1
dispatch.earliest_time = -10m@m
dispatch.latest_time = -0m@m
dispatch.rt_backfill = 1
enableSched = 1
quantity = 0
realtime_schedule = 0
relation = greater than
request.ui_dispatch_app = DA-ESS-OTSecurity
search = index="notable" ( \
OR search_name="New Interactive Logon from a Service Account"\
OR search_name="Significant Increase in Interactive Logons"\
OR search_name="New Logon Type for User"\
OR search_name="New RunAs Host / Privileged Account Combination"\
OR search_name="Significant Increase in Interactively Logged On Users"\
OR search_name="User Login with Local Credentials"\
OR search_name="New User Taking Privileged Actions"\
OR search_name="Stale Account Usage"\
OR search_name="Short-lived Account Detecte"\
OR search_name="Concurrent Login Attempts Detected"\
OR search_name="High or Critical Priority Individual Logging into Infected Machine"\
OR search_name="Geographically Improbable Access Detected"\
OR search_name="Non-Privileged Users taking Privileged Actions"\
OR search_name="User Logged into In-Scope System They Should Not Have"\
OR search_name="Activity from Expired User Identity-on Category"\
OR search_name="Brute Force Access Behavior Detected-Against Category"\
OR search_name="Completely Inactive Account"\
OR search_name="Successful Login of Account for Former Employee"\
OR search_name="Geographically Improbable Access Detected for Privileged Accounts"\
OR search_name="Brute Force Access Behavior Detected Over One Day - Against Category" )\
\
| rename host as dvc\
| lookup ot_asset_lookup ip as dest \
| lookup ot_asset_lookup ip as src \
| lookup ot_asset_lookup ip as dvc \
\
| search ( asset_type=ot_vpn OR asset_type=ot_jumpserver ) priority=*\
\
| stats last(infection_count) as infection_count, values(asset_criticality) as asset_criticality, values(asset_type) as asset_type, values(category) as category, values(nt_host) as nt_host, values(location) as location, values(vendor_product) as vendor_product, values(hw_model) as hw_model, values(hw_join) as hw_join, count,  latest(_raw) as "orig_raw" by dvc

[Threat - OT Sec - Replication Through Removable Media - Rule]
action.correlationsearch.enabled = 1
action.correlationsearch.label = OT Sec - Replication Through Removable Media
action.customsearchbuilder.enabled = false
action.customsearchbuilder.spec = {}
action.notable = 1
action.notable.param.rule_description = Removable media detected on critical assets - Potential Replication Through Removable Media MITRE ICS SECURITY -T847
action.notable.param.rule_title = OT Sec - Replication Through Removable Media
action.notable.param.security_domain = threat
action.notable.param.severity = high
action.notable.param.verbose = 0
action.risk = 1
action.risk.param._risk_object = dvc
action.risk.param._risk_object_type = system
action.risk.param._risk_score = 10
action.risk.param.verbose = 0
alert.suppress = 1
alert.suppress.fields = dvc
alert.suppress.period = 3600s
alert.track = 1
counttype = number of events
cron_schedule = */10 * * * *
description = OT Sec - Replication Through Removable Media.\
Setup : Define your own source for endpoint media detection
disabled = 1
dispatch.earliest_time = -10m@m
dispatch.latest_time = -0m@m
dispatch.rt_backfill = 1
enableSched = 1
quantity = 0
realtime_schedule = 0
relation = greater than
request.ui_dispatch_app = DA-ESS-OTSecurity
search = (index=main sourcetype="sophos:devicecontrol" EventType="Device control")\
| rename ComputerName as dvc, category as device_category\
| lookup ot_asset_lookup ip as dest \
| lookup ot_asset_lookup ip as src \
| lookup ot_asset_lookup ip as dvc \
| search asset_type=* ( assset_criticality=critical assset_criticality=high )\
| stats values(asset_criticality) as asset_criticality, values(asset_type) as asset_type, values(category) as category, values(nt_host) as nt_host, values(location) as location, values(vendor_product) as vendor_product, values(hw_model) as hw_model, values(hw_join) as hw_join, count,  latest(_raw) as "orig_raw" by dvc

[Threat - OT Sec - Spearphishing Attachment related activity - Rule]
action.correlationsearch.enabled = 1
action.correlationsearch.label = OT Sec - Spearphishing Attachment related activity
action.customsearchbuilder.enabled = false
action.customsearchbuilder.spec = {}
action.notable = 1
action.notable.param.rule_description = Potential Spearphishing activity detected on critical assets - MITRE ICS SECURITY -T865
action.notable.param.rule_title = OT Sec - Spearphishing Attachment related activity
action.notable.param.security_domain = threat
action.notable.param.severity = high
action.notable.param.verbose = 0
action.risk = 1
action.risk.param._risk_object = src
action.risk.param._risk_object_type = system
action.risk.param._risk_score = 100
action.risk.param.verbose = 0
alert.suppress = 1
alert.suppress.fields = src
alert.suppress.period = 3600s
alert.track = 1
counttype = number of events
cron_schedule = 0 * * * *
description = OT Sec - Spearphishing Attachment related activity : Customize Time Range
disabled = 1
dispatch.earliest_time = -60m@m
dispatch.latest_time = -0m@m
dispatch.rt_backfill = 1
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = SplunkEnterpriseSecuritySuite
search = index="notable" (\
OR search_name="Detect DNS requests to Phishing Sites "\
OR search_name="ESCU - Detect Oulook.exe writing a .zip file"\
OR search_name="ESCU - Suspicious LNK file launching a process"\
OR search_name="ESCU - Detect DNS requests to Phishing Sites leveraging EvilGinx2"\
OR search_name="Basic Malware Outbreak (SSE)"\
OR search_name="Recurring Infection on Host (SSE)"\
OR search_name="Endpoint Uncleaned Malware Detection (SSE)"\
OR search_name="Multiple Infections on Host (SSE)"\
OR search_name="Host With Multiple Infections (ES)"\
OR search_name="Email with attachmet with long spaces (SSE)"\
OR search_name="Dynamic DNS ESCU - web traffic to ddns"\
OR search_name="Ddns activity detected"\
OR search_name="Automatic Domain Generated Algorhithm detected (UBA)" )\
\
| lookup ot_asset_lookup ip as dest \
| lookup ot_asset_lookup ip as src \
| lookup ot_asset_lookup ip as dvc \
\
| search ( asset_type=”eng* work*” OR asset_type=”Human-Machine Interface” OR asset_type=“Data Historian” OR  asset_type=“Control Server” ) priority=*\
\
| stats count, values(asset_criticality) as asset_criticality, values(asset_type) as asset_type, values(category) as category, values(nt_host) as nt_host, values(location) as location, values(vendor_product) as vendor_product, values(hw_model) as hw_model, values(hw_join) as hw_join,  latest(_raw) as "orig_raw" by src

[Threat - OT Sec - Command-Line Interface - Rule]
action.correlationsearch.enabled = 1
action.correlationsearch.label = OT Sec - Command-Line Interface
action.customsearchbuilder.enabled = false
action.customsearchbuilder.spec = {}
action.notable = 1
action.notable.param.rule_description = Potential Command-Line Interface activity detected at the Endpoint - MITRE ICS SECURITY -T807
action.notable.param.rule_title = OT Sec - Command-Line Interface
action.notable.param.security_domain = threat
action.notable.param.severity = high
action.notable.param.verbose = 0
action.risk = 1
action.risk.param._risk_object = dvc
action.risk.param._risk_object_type = system
action.risk.param._risk_score = 100
action.risk.param.verbose = 0
alert.suppress = 1
alert.suppress.fields = dvc
alert.suppress.period = 3600s
alert.track = 1
counttype = number of events
cron_schedule = 0 * * * *
description = OT Sec - Command-Line Interface: T807
disabled = 1
dispatch.earliest_time = -60m@m
dispatch.latest_time = -0m@m
dispatch.rt_backfill = 1
enableSched = 1
quantity = 0
realtime_schedule = 0
relation = greater than
request.ui_dispatch_app = SplunkEnterpriseSecuritySuite
search = index="notable" (\
OR search_name="Malicious PowerShell Process - Connect To Internet With Hidden Window"\
OR search_name="Malicious PowerShell Process - Encoded Command"\
OR search_name="Malicious PowerShell Process - Execution Policy Bypass"\
OR search_name="Malicious PowerShell Process - Multiple Suspicious Command-Line Arguments"\
OR search_name="Malicious PowerShell Process With Obfuscation Techniques"\
OR search_name="Remote Desktop Process Running On System"\
OR search_name="Remote Process Instantiation via WMI"\
OR search_name="Prohibited Process Detected"\
OR search_name="Create local admin accounts using net.exe (ESCU)"\
OR search_name="Malicious Command Line Executions (SSE)"\
OR search_name="Unusually Long Command Line (ESCU)"\
OR search_name="Concentration of Attacker Tools by SHA1 Hash (SSE)"\
OR search_name="Processes launching netsh (SSE)"\
OR search_name="New Parent Process for cmd.exe or regedit.exe (SSE)"\
OR search_name="Deleting Shadow Copies (ESCU)"\
OR search_name="Detect PsExec With accepteula Flag (ESCU)"\
OR search_name="First time seen command line argument (ESCU)"\
OR search_name="Detect mshta.exe running scripts in command-line arguments (ESCU)"\
OR search_name="Detect Use of cmd.exe to Launch Script Interpreters (ESCU)"\
OR search_name="Processes created by netsh (ESCU)"\
OR search_name="Concentration of Attacker Tools by Filename (SSE)"\
OR search_name="Detect Prohibited Applications Spawning cmd.exe (ESCU)"\
OR search_name="Create or delete hidden shares using net.exe (ESCU)"\
OR search_name="New Suspicious Executable Launch for User (SSE)"\
OR search_name="Find Unusually Long CLI Commands (SSE)"\
OR search_name="Processes launching netsh - Rule (ESCU)"\
OR search_name="ESCU - Processes launching netsh - Rule"\
 )\
\
| rename host as dvc\
| lookup ot_asset_lookup ip as dest \
| lookup ot_asset_lookup ip as src \
| lookup ot_asset_lookup ip as dvc \
\
| search asset_type=* priority=*\
\
| stats last(infection_count) as infection_count, values(asset_criticality) as asset_criticality, values(asset_type) as asset_type, values(category) as category, values(nt_host) as nt_host, values(location) as location, values(vendor_product) as vendor_product, values(hw_model) as hw_model, values(hw_join) as hw_join, count,  latest(_raw) as "orig_raw" by dvc\


[Threat - OT Sec - Scripting - Rule]
action.correlationsearch.enabled = 1
action.correlationsearch.label = OT Sec - Scripting
action.customsearchbuilder.enabled = false
action.customsearchbuilder.spec = {}
action.notable = 1
action.notable.param.rule_description = Suspicious Scripting Activity Detected on engineering workstations - MITRE ICS SECURITY -  T853
action.notable.param.rule_title = OT Sec - Scripting
action.notable.param.security_domain = threat
action.notable.param.severity = high
action.notable.param.verbose = 0
action.risk = 1
action.risk.param._risk_object = dvc
action.risk.param._risk_object_type = system
action.risk.param._risk_score = 100
action.risk.param.verbose = 0
alert.suppress = 1
alert.suppress.fields = dvc
alert.suppress.period = 3600s
alert.track = 1
counttype = number of events
cron_schedule = 0 * * * *
description = OT Sec - Scripting
disabled = 1
dispatch.earliest_time = -60m@m
dispatch.latest_time = -0m@m
dispatch.rt_backfill = 1
enableSched = 1
quantity = 0
realtime_schedule = 0
relation = greater than
request.ui_dispatch_app = SplunkEnterpriseSecuritySuite
search = ( search_name="Malicious PowerShell Process - Connect To Internet With Hidden Window"\
OR search_name="Malicious PowerShell Process - Encoded Command"\
OR search_name="Malicious PowerShell Process - Execution Policy Bypass"\
OR search_name="Malicious PowerShell Process - Multiple Suspicious Command-Line Arguments"\
OR search_name="Malicious PowerShell Process With Obfuscation Techniques"\
OR search_name="Remote Desktop Process Running On System"\
OR search_name="Remote Process Instantiation via WMI"\
OR search_name="Prohibited Process Detected"\
OR search_name="Attempt To Set Default PowerShell Execution Policy To Unrestricted or Bypass - Rule"\
OR search_name="First time seen command line argument - Rule" )\
\
| lookup ot_asset_lookup ip as dest \
| lookup ot_asset_lookup ip as src \
| lookup ot_asset_lookup ip as dvc \
| search asset_type="eng* work*" asset_criticality=*\
\
| stats values(asset_criticality) as asset_criticality, values(asset_type) as asset_type, values(category) as category, values(nt_host) as nt_host, values(location) as location, values(vendor_product) as vendor_product, values(hw_model) as hw_model, values(hw_join) as hw_join, count,  latest(_raw) as "orig_raw" by dvc

[Threat - OT Sec - User Execution - Rule]
action.correlationsearch.enabled = 1
action.correlationsearch.label = OT Sec - User Execution
action.customsearchbuilder.enabled = false
action.customsearchbuilder.spec = {}
action.notable = 1
action.notable.param.rule_description = Malicious files executed at the endpoint - MITRE ICS SECURITY -T863
action.notable.param.rule_title = OT Sec - User Execution
action.notable.param.security_domain = threat
action.notable.param.severity = high
action.notable.param.verbose = 0
action.risk = 1
action.risk.param._risk_object = dvc
action.risk.param._risk_object_type = system
action.risk.param._risk_score = 100
action.risk.param.verbose = 0
alert.suppress = 1
alert.suppress.fields = dvc
alert.suppress.period = 3600s
alert.track = 1
counttype = number of events
cron_schedule = 0 * * * *
description = OT Sec - User Execution - T863
disabled = 1
dispatch.earliest_time = -60m@m
dispatch.latest_time = -0m@m
dispatch.rt_backfill = 1
enableSched = 1
quantity = 0
realtime_schedule = 0
relation = greater than
request.ui_dispatch_app = SplunkEnterpriseSecuritySuite
search = index=notable ( search_name="Suspicious Email Attachment Extensions"\
OR search_name="Email Attachments With Lots Of Spaces"\
OR search_name="Threat - File Hash Matches - Threat Gen"\
OR search_name="Endpoint Uncleaned Malware Detection"\
OR search_name="Basic Malware Outbreak"\
OR search_name="Multiple Infections on Host"\
OR search_name="Recurring Infection on Host"\
OR search_name="Host With A Recurring Malware Infection"\
OR search_name="Host With Multiple Infections"\
OR search_name="Host With Old Infection Or Potential Re-Infection"\
OR search_name="Ransomware Note Files"\
OR search_name="Ransomware Extensions"\
OR search_name="High Or Critical Priority Host With Malware Detected " )\
| lookup ot_asset_lookup ip as dest \
| lookup ot_asset_lookup ip as src \
| lookup ot_asset_lookup ip as dvc \
| search asset_type="eng* work*" asset_criticality=*\
\
| stats values(asset_criticality) as asset_criticality, values(asset_type) as asset_type, values(category) as category, values(nt_host) as nt_host, values(location) as location, values(vendor_product) as vendor_product, values(hw_model) as hw_model, values(hw_join) as hw_join, count,  latest(_raw) as "orig_raw" by dvc

[Threat - OT Sec - Network Service Scanning - Rule]
action.correlationsearch.enabled = 1
action.correlationsearch.label = OT Sec - Network Service Scanning
action.customsearchbuilder.enabled = false
action.customsearchbuilder.spec = {}
action.notable = 1
action.notable.param.rule_description = Network scanning activities detected targeting OT assets - MITRE ICS SECURITY - T841
action.notable.param.rule_title = OT Sec - Network Service Scanning
action.notable.param.security_domain = threat
action.notable.param.severity = high
action.notable.param.verbose = 0
action.risk = 1
action.risk.param._risk_object = dest
action.risk.param._risk_object_type = system
action.risk.param._risk_score = 100
action.risk.param.verbose = 0
alert.suppress = 1
alert.suppress.fields = dest
alert.suppress.period = 3600s
alert.track = 1
counttype = number of events
cron_schedule = 0 * * * *
description = OT Sec - Network Service Scanning
disabled = 1
dispatch.earliest_time = -60m@m
dispatch.latest_time = -0m@m
dispatch.rt_backfill = 1
enableSched = 1
quantity = 0
realtime_schedule = 0
relation = greater than
request.ui_dispatch_app = SplunkEnterpriseSecuritySuite
search = index=notable ( search_name="Hosts Sending To More Destinations Than Normal"\
OR search_name="Unauthorized Connection Through Firewall"\
OR search_name="Basic Scanning"\
OR search_name="Unrouteable Activity Detected"\
OR search_name="Concentration of Attacker Tools by Filename"\
OR search_name="Vulnerability Scanner Detected (by events)"\
OR search_name="Vulnerability Scanner Detected (by targets)"\
OR search_name="Scanning Activity (UBA)" )\
\
\
| lookup ot_asset_lookup ip as dest \
| lookup ot_asset_lookup ip as src \
| lookup ot_asset_lookup ip as dvc \
| search asset_type="*" asset_criticality=*\
\
| stats values(asset_criticality) as asset_criticality, values(asset_type) as asset_type, values(category) as category, values(nt_host) as nt_host, values(location) as location, values(vendor_product) as vendor_product, values(hw_model) as hw_model, values(hw_join) as hw_join, count,  latest(_raw) as "orig_raw" by dvc

[Threat - OT Sec - Remote System Discovery - Rule]
action.correlationsearch.enabled = 1
action.correlationsearch.label = OT Sec - Remote System Discovery
action.customsearchbuilder.enabled = false
action.customsearchbuilder.spec = {}
action.notable = 1
action.notable.param.rule_description = Detected remote discovery activities that involved critical OT assets - MITRE ICS SECURITY - T846
action.notable.param.rule_title = OT Sec - Remote System Discovery
action.notable.param.security_domain = threat
action.notable.param.severity = high
action.notable.param.verbose = 0
action.risk = 1
action.risk.param._risk_object = dest
action.risk.param._risk_object_type = system
action.risk.param._risk_score = 10
action.risk.param.verbose = 0
alert.suppress = 1
alert.suppress.fields = dest
alert.suppress.period = 3600s
alert.track = 1
counttype = number of events
cron_schedule = 0 * * * *
description = OT Sec - Remote System Discovery - Monitor network scanning activities that attemps to map targets, like PLCs
disabled = 1
dispatch.earliest_time = -60m@m
dispatch.latest_time = -0m@m
dispatch.rt_backfill = 1
enableSched = 1
quantity = 0
realtime_schedule = 0
relation = greater than
request.ui_dispatch_app = SplunkEnterpriseSecuritySuite
search = | tstats `summariesonly` max(_time) as _time,values(All_Traffic.action) as action,values(All_Traffic.src_port) as src_port,values(All_Traffic.dest_port) as dest_port,dc(All_Traffic.dest_port) as dest_port_cnt, dc(All_Traffic.dest) as dest_ip_cnt, values(All_Traffic.dest) as dest_ip_list,count from datamodel=Network_Traffic.All_Traffic where * (All_Traffic.src="*" OR All_Traffic.src_ip="*" OR All_Traffic.src_mac="*" OR All_Traffic.src_translated_ip="*") (All_Traffic.dest="*" OR All_Traffic.dest_ip="*" OR All_Traffic.dest_mac="*" OR All_Traffic.dest_translated_ip="*") by All_Traffic.src \
| `drop_dm_object_name("All_Traffic")` \
| search dest_ip_cnt>50 \
| fields _time,action,src,dest,transport,dest_port_cnt, dest_ip_cnt dest_ip_list count \
| mvexpand dest_ip_list\
| eval dest=dest_ip_list\
| lookup ot_asset_lookup ip as dest \
| lookup ot_asset_lookup ip as src \
| lookup ot_asset_lookup ip as dvc\
| search asset_type=* asset_criticality=*

[Threat - OT Sec - Remote File Copy - Rule]
action.correlationsearch.enabled = 1
action.correlationsearch.label = OT Sec - Remote File Copy
action.customsearchbuilder.enabled = false
action.customsearchbuilder.spec = {}
action.notable = 1
action.notable.param.rule_description = Network Transfers using Remote File Copy (SMB) 1mb over detected - MITRE ICS SECURITY - 867
action.notable.param.rule_title = OT Sec - Remote File Copy
action.notable.param.security_domain = threat
action.notable.param.severity = high
action.notable.param.verbose = 0
action.risk = 1
action.risk.param._risk_object = dest
action.risk.param._risk_object_type = system
action.risk.param._risk_score = 100
action.risk.param.verbose = 0
alert.suppress = 1
alert.suppress.fields = dest
alert.suppress.period = 3600s
alert.track = 1
counttype = number of events
cron_schedule = 0 * * * *
description = OT Sec - Remote File Copy- - Detecting file transfer activites through services like SMB,FTP and others to spread attack assets to other hosts(ot OT assets) in the network
disabled = 1
dispatch.earliest_time = -60m@m
dispatch.latest_time = -0m@m
dispatch.rt_backfill = 1
enableSched = 1
quantity = 0
realtime_schedule = 0
relation = greater than
request.ui_dispatch_app = SplunkEnterpriseSecuritySuite
search = index=notable ( search_name="Spike in SMB Traffic"\
OR search_name="Suspicious Network Connection (UBA)"\
OR search_name="Suspicious Network Exploration (UBA)" )\
\
| lookup ot_asset_lookup ip as dest \
| lookup ot_asset_lookup ip as src \
| lookup ot_asset_lookup ip as dvc \
| search asset_type="*" asset_criticality=*\
\
| stats values(asset_criticality) as asset_criticality, values(asset_type) as asset_type, values(category) as category, values(nt_host) as nt_host, values(location) as location, values(vendor_product) as vendor_product, values(hw_model) as hw_model, values(hw_join) as hw_join, count,  latest(_raw) as "orig_raw" by dvc\


[Threat - OT Sec - Data from Information Repositories - Rule]
action.correlationsearch.enabled = 1
action.correlationsearch.label = OT Sec - Data from Information Repositories
action.customsearchbuilder.enabled = false
action.customsearchbuilder.spec = {}
action.notable = 1
action.notable.param.rule_description = Suspicious activities from OT assets access Data from Information Repositories - MITRE ICS SECURITY - T811
action.notable.param.rule_title = OT Sec - Data from Information Repositories
action.notable.param.security_domain = threat
action.notable.param.severity = high
action.notable.param.verbose = 0
action.risk = 1
action.risk.param._risk_object = dvc
action.risk.param._risk_object_type = system
action.risk.param._risk_score = 100
action.risk.param.verbose = 0
alert.suppress = 1
alert.suppress.fields = dvc
alert.suppress.period = 3600s
alert.track = 1
counttype = number of events
cron_schedule = 0 * * * *
description = OT Sec - Data from Information Repositories, \
Customize the following conditions :\
FILTER object_category is "*dwg*" FILTER object_path is "*design*"
disabled = 1
dispatch.earliest_time = -60m@m
dispatch.latest_time = -0m@m
dispatch.rt_backfill = 1
enableSched = 1
quantity = 0
realtime_schedule = 0
relation = greater than
request.ui_dispatch_app = SplunkEnterpriseSecuritySuite
search = index=notable ( search_name="First Time Accessing an Internal Git Repository"\
OR search_name="Increase in Source Code (Git) Downloads"\
OR search_name="First Time Accessing an Internal Git Repository Not Viewed by Peers"\
OR search_name="User Logged into In-Scope System They Should Not Have"\
OR search_name="User Finding Project Code Names from Many Departments"\
OR search_name="Download from Internal Server"\
OR search_name="Suspicious Data Movement " )\
\
| lookup ot_asset_lookup ip as dest \
| lookup ot_asset_lookup ip as src \
| lookup ot_asset_lookup ip as dvc \
| search asset_type="*" asset_criticality=*\
\
| stats values(asset_criticality) as asset_criticality, values(asset_type) as asset_type, values(category) as category, values(nt_host) as nt_host, values(location) as location, values(vendor_product) as vendor_product, values(hw_model) as hw_model, values(hw_join) as hw_join, count,  latest(_raw) as "orig_raw" by dvc\


[Threat - OT Sec - Commonly Used Port - Rule]
action.correlationsearch.enabled = 1
action.correlationsearch.label = OT Sec - Commonly Used Port
action.customsearchbuilder.enabled = false
action.customsearchbuilder.spec = {}
action.notable = 1
action.notable.param.rule_description = Commonly Used Port activity Detected - MITRE ICS SECURITY - T885
action.notable.param.rule_title = OT Sec - Commonly Used Port
action.notable.param.security_domain = ot_asset
action.notable.param.severity = high
action.notable.param.verbose = 0
action.risk = 1
action.risk.param._risk_object = dest
action.risk.param._risk_object_type = system
action.risk.param._risk_score = 100
action.risk.param.verbose = 0
alert.suppress = 1
alert.suppress.fields = dest
alert.suppress.period = 3600s
alert.track = 1
counttype = number of events
cron_schedule = 0 * * * *
description = OT Sec - Commonly Used Port
disabled = 1
dispatch.earliest_time = -60m@m
dispatch.latest_time = -0m@m
dispatch.rt_backfill = 1
enableSched = 1
quantity = 0
realtime_schedule = 0
relation = greater than
request.ui_dispatch_app = SplunkEnterpriseSecuritySuite
search = index=notable ( search_name="ESCU - Detect Long DNS TXT Record Response - Rule"\
OR search_name="ESCU - Detect Outbound SMB Traffic - Rule"\
OR search_name="ESCU - Detection of DNS Tunnels - Rule"\
OR search_name="ESCU - DNS Query Length Outliers - MLTK - Rule"\
OR search_name="ESCU - DNS Query Length With High Standard Deviation - Rule"\
OR search_name="ESCU - Email servers sending high volume traffic to hosts - Rule"\
OR search_name="ESCU - Excessive DNS Failures - Rule"\
OR search_name="ESCU - Hosts receiving high volume of network traffic from email server - Rule"\
OR search_name="ESCU - Prohibited Network Traffic Allowed - Rule"\
OR search_name="ESCU - Protocol or Port Mismatch - Rule" )\
\
| lookup ot_asset_lookup ip as dest \
| lookup ot_asset_lookup ip as src \
| lookup ot_asset_lookup ip as dvc \
| search asset_type="*" asset_criticality=*\
\
| stats values(asset_criticality) as asset_criticality, values(asset_type) as asset_type, values(category) as category, values(nt_host) as nt_host, values(location) as location, values(vendor_product) as vendor_product, values(hw_model) as hw_model, values(hw_join) as hw_join, count,  latest(_raw) as "orig_raw" by dvc\


[Threat - OT Sec - Standard Application Layer Protocol - Rule]
action.correlationsearch.enabled = 1
action.correlationsearch.label = OT Sec - Standard Application Layer Protocol
action.customsearchbuilder.enabled = false
action.customsearchbuilder.spec = {}
action.notable = 1
action.notable.param.rule_description = OT assets attempted to communicate to external host via Standard Application Protocol - MITRE ICS SECURITY - T869
action.notable.param.rule_title = OT Sec - Standard Application Layer Protocol
action.notable.param.security_domain = ot_asset
action.notable.param.severity = high
action.notable.param.verbose = 0
action.risk = 1
action.risk.param._risk_object = src
action.risk.param._risk_object_type = system
action.risk.param._risk_score = 100
action.risk.param.verbose = 0
alert.suppress = 1
alert.suppress.fields = src
alert.suppress.period = 3600s
alert.track = 1
counttype = number of events
cron_schedule = 0 * * * *
description = OT Sec - Standard Application Layer Protocol - Customize "dest" to outside network. \
| search asset_type=* asset_criticality=* NOT (dest=192.* OR dest=10.* OR dest=172.* )
disabled = 1
dispatch.earliest_time = -60m@m
dispatch.latest_time = -0m@m
dispatch.rt_backfill = 1
enableSched = 1
quantity = 0
realtime_schedule = 0
relation = greater than
request.ui_dispatch_app = SplunkEnterpriseSecuritySuite
search = index=notable ( search_name="Detect Large Outbound ICMP Packets - Rule"\
OR search_name="Sources Sending a High Volume of DNS Traffic"\
OR search_name="Web Browsing to Unauthorized Sites"\
OR search_name="Sources Sending Many DNS Requests"\
OR search_name="Basic TOR Traffic Detection"\
OR search_name="Basic Dynamic DNS Detection"\
OR search_name="Connection to New Domain"\
OR search_name="Excessive DNS Queries"\
OR search_name="Unusual Web Browser"\
OR search_name="Unusual Geolocation of Communication Destination"\
OR search_name="Blacklisted IP Address"\
OR search_name="Blacklisted Domain"\
OR search_name="Threat Activity Detected"\
OR search_name="Suspicious Domain Communication"\
OR search_name="Suspicious Domain Name"\
OR search_name="Suspicious IP Address Communication"\
OR search_name="Machine Generated Beacon " )\
\
| lookup ot_asset_lookup ip as dest \
| lookup ot_asset_lookup ip as src \
| lookup ot_asset_lookup ip as dvc \
| search asset_type="*" asset_criticality=*\
\
| stats values(asset_criticality) as asset_criticality, values(asset_type) as asset_type, values(category) as category, values(nt_host) as nt_host, values(location) as location, values(vendor_product) as vendor_product, values(hw_model) as hw_model, values(hw_join) as hw_join, count,  latest(_raw) as "orig_raw" by dvc\


[Threat - OT Sec - Project File Infection - Rule]
action.correlationsearch.enabled = 1
action.correlationsearch.label = OT Sec - Project File Infection
action.customsearchbuilder.enabled = false
action.customsearchbuilder.spec = {}
action.notable = 1
action.notable.param.rule_description = Potential Project File Infection detected at the endpoint - MITRE ICS SECURITY -T873
action.notable.param.rule_title = OT Sec - Project File Infection
action.notable.param.security_domain = ot_asset
action.notable.param.severity = high
action.notable.param.verbose = 0
action.risk = 1
action.risk.param._risk_object = dest
action.risk.param._risk_object_type = system
action.risk.param._risk_score = 10
action.risk.param.verbose = 0
alert.suppress = 1
alert.suppress.fields = dest
alert.suppress.period = 3600s
alert.track = 1
counttype = number of events
cron_schedule = 0 * * * *
description = OT Sec - Project File Infection
disabled = 1
dispatch.earliest_time = -60m@m
dispatch.latest_time = -0m@m
dispatch.rt_backfill = 1
enableSched = 1
quantity = 0
realtime_schedule = 0
relation = greater than
request.ui_dispatch_app = SplunkEnterpriseSecuritySuite
search = | tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime values(Filesystem.user) as user values(Filesystem.dest) as dest, values(Filesystem.file_path) as file_path from datamodel=Endpoint.Filesystem by Filesystem.file_name \
| `drop_dm_object_name(Filesystem)` \
| `security_content_ctime(lastTime)` \
| `security_content_ctime(firstTime)` \
| rex field=file_name "(?<file_extension>\.[^\.]+)$" \
| search file_extension=.MPP OR file_extension=.mpp OR file_extension=.project\
| append \
    [search index="notable" search_name="Prohibited Process Detected" OR “search_name="Basic Malware Outbreak"\
| lookup ot_asset_lookup ip as dest \
| lookup ot_asset_lookup ip as src \
| lookup ot_asset_lookup ip as dvc \
| search asset_type=* asset_criticality=*\
| stats last(infection_count) as infection_count, values(asset_criticality) as asset_criticality, values(asset_type) as asset_type, values(category) as category, values(nt_host) as nt_host, values(location) as location, values(vendor_product) as vendor_product, values(hw_model) as hw_model, values(hw_join) as hw_join, count,  latest(_raw) as "orig_raw" by dest\
]\
| lookup ot_asset_lookup ip as dest \
| lookup ot_asset_lookup ip as src \
| lookup ot_asset_lookup ip as dvc \
| search asset_type=* asset_criticality=*\
| stats values(asset_criticality) as asset_criticality, values(asset_type) as asset_type, values(category) as category, values(nt_host) as nt_host, values(location) as location, values(vendor_product) as vendor_product, values(hw_model) as hw_model, values(hw_join) as hw_join, count,  latest(_raw) as "orig_raw" by dest

[Threat - OT Sec - Default Credentials - Rule]
action.correlationsearch.enabled = 1
action.correlationsearch.label = OT Sec - Default Credentials
action.customsearchbuilder.enabled = false
action.customsearchbuilder.spec = {}
action.notable = 1
action.notable.param.rule_description = Default credentials activity detected on OT assets - MITRE ICS SECURITY - T812
action.notable.param.rule_title = OT Sec - Default Credentials
action.notable.param.security_domain = ot_asset
action.notable.param.severity = high
action.notable.param.verbose = 0
action.risk = 1
action.risk.param._risk_object = dest
action.risk.param._risk_object_type = system
action.risk.param._risk_score = 10
action.risk.param.verbose = 0
alert.suppress = 1
alert.suppress.fields = dest
alert.suppress.period = 3600s
alert.track = 1
counttype = number of events
cron_schedule = 0 * * * *
description = OT Sec - Default Credentials
disabled = 1
dispatch.earliest_time = -60m@m
dispatch.latest_time = -0m@m
dispatch.rt_backfill = 1
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = SplunkEnterpriseSecuritySuite
search = | tstats `summariesonly` max(_time) as _time,values(Authentication.user_category) as user_category,from datamodel=Authentication.Authentication where Authentication.user_category=default by  Authentication.dest Authentication.user\
| `drop_dm_object_name("Authentication")` \
| search user=system OR user=scada OR user=admin OR user=operator OR user=ops OR user=super OR user=root OR user=sys OR user=manager\
| search NOT ( dest=IP_EXCEPTION OR dest=IP_EXCEPTION OR dest=IP_EXCEPTION OR dest=IP_EXCEPTION OR dest=IP_EXCEPTION OR dest=IP_EXCEPTION)\
| lookup ot_asset_lookup ip as dest \
| lookup ot_asset_lookup ip as src \
| lookup ot_asset_lookup ip as dvc \
| search asset_type=* priority=*\
| stats last(infection_count) as infection_count, values(priority) as priority, values(asset_type) as asset_type, values(category) as category, values(nt_host) as nt_host, values(location) as location, values(asset_vendor) as asset_vendor, values(asset_model) as asset_model, values(hw_join) as hw_join, count,  latest(_raw) as "orig_raw" by dvc

[OT Assets - OEE]
action.keyindicator = 1
action.keyindicator.delta = OEE
action.keyindicator.subtitle = Operational Health KPI
action.keyindicator.title = Operational OEE
action.keyindicator.value = OEE
action.keyindicator.value_suffix = %
enableSched = false
search = index=_internal\
| head 5\
| eval high = 85\
| eval low = 78\
| eval OEE = round(((random() % high)/(high)) * (high - low) + low)\
| table _time, OEE

[ot_sec_tot_risk_score]
action.keyindicator = 1
action.keyindicator.delta = risk_score
action.keyindicator.subtitle = ot_sec_tot_risk_score
action.keyindicator.title = ot_sec_tot_risk_score
action.keyindicator.value = risk_score
search = index=risk \
| eval _time=strftime(_time,"%Y-%m-%d")\
| stats sum(risk_score) as risk_score by _time, risk_object, risk_object_type\
| lookup ot_asset_lookup ip as risk_object \
| lookup cip_asset_lookup ip as risk_object \
| search asset_type=*\
| stats sum(risk_score) as risk_score by _time

[OT Vulnerability - New CVEs]
action.keyindicator = 1
action.keyindicator.delta = count
action.keyindicator.group.0.name = ot_asset_center
action.keyindicator.group.0.order = 3
action.keyindicator.group.1.name = ot_asset_bulletin_updates
action.keyindicator.group.1.order = 0
action.keyindicator.subtitle = Newly CVEs published today
action.keyindicator.title = OT Asset - Vulnerability - New CVEs
action.keyindicator.value = count
enableSched = false
search = index=cve publishedDate="2020*"\
| rex field=publishedDate "(?P<evt_date>\d{4}-\d{2}-\d{2})"\
| eval time_evt=strptime(publishedDate, "%Y-%m-%d")\
| eval _time=time_evt\
| eval time_now=now()\
| eval time_diff=time_now-time_evt\
| search time_diff<2592000\
| table _time cve time*\
| timechart count span=1d

[evt_sum_ot_asset_traffic_snap_1d]
action.email.useNSSubject = 1
action.keyindicator.invert = 0
action.makestreams.param.verbose = 0
action.nbtstat.param.verbose = 0
action.notable.param.verbose = 0
action.nslookup.param.verbose = 0
action.ping.param.verbose = 0
action.risk.param.verbose = 0
action.send2uba.param.verbose = 0
action.summary_index._name = evt_sum_ot_asset_traffic
action.summary_index.sum_type = evt_sum_ot_asset_traffic_1d
action.threat_add.param.verbose = 0
alert.track = 0
cron_schedule = 10 0 * * *
dispatch.earliest_time = -1d@d
dispatch.latest_time = -0d@d
display.events.fields = ["host","source","sourcetype","lastModifiedDate","cve","cve_prod","description","product_name","vendor_product","ref_url","name","asset_id","asset_model","asset_status","asset_type","asset_type","asset_type","asset_type","asset_type","asset_type","asset_type ","asset_vendor","asset_version","classification","location","exposure","nt_host","ip","zone","priority"]
display.general.type = statistics
display.page.search.mode = verbose
display.page.search.tab = statistics
display.visualizations.charting.chart = bar
display.visualizations.show = 0
enableSched = 1
realtime_schedule = 0
request.ui_dispatch_app = DA-ESS-OTSecurity
request.ui_dispatch_view = search
search = index=evt_sum_ot_asset_traffic ( dest_asset_type="*" or src_asset_type="*" or dvc_asset_type=* ) sum_type=evt_sum_ot_asset_traffic_1d \
| stats sum(tot_bytes) as tot_bytes, sum(tot_port_com_num) as tot_port_com_num, sum(tot_session) as tot_session, sum(tot_duration) as tot_duration by dest \
| append \
    [ search index=evt_sum_ot_asset_traffic src_asset_type="*" sum_type=evt_sum_ot_asset_traffic_1d\
    | stats sum(tot_bytes) as tot_bytes, sum(tot_port_com_num) as tot_port_com_num, sum(tot_session) as tot_session, sum(tot_duration) as tot_duration by src] \
| strcat src dest dvc \
| stats sum(tot_bytes) as tot_bytes, avg(tot_port_com_num) as avg_port_com_num, sum(tot_session) as tot_session, sum(tot_duration) as tot_duration by dvc \
| sort - tot_bytes \
| table dvc tot_bytes avg_port_com_num tot_session tot_duration\
| collect index=evt_sum_ot_asset_traffic marker="sum_type=evt_sum_ot_asset_traffic_snap_1d"

[OT Assets - Total Assets SW]
action.keyindicator = 1
action.keyindicator.group.0.name = ot_asset_center
action.keyindicator.group.0.order = 1
action.keyindicator.group.1.name = ot_asset_status_search
action.keyindicator.group.1.order = 1
action.keyindicator.group.2.name = ot_asset_center_01
action.keyindicator.group.2.order = 1
action.keyindicator.subtitle = Total SW Assets
action.keyindicator.title = OT Assets - Total Assets SW
action.keyindicator.value = count
cron_schedule = 0 0 * * *
dispatch.earliest_time = -1d@d
enableSched = 1
search = `get_ot_assets_sw`\
| stats count

[OT Assets - Critical Assets /w Vulnerability]
action.keyindicator = 1
action.keyindicator.subtitle = Total number of current critical assets with CVE vulnerability
action.keyindicator.title = OT Assets - Critical Assets /w Vulnerability
action.keyindicator.value = count
alert.track = 0
cron_schedule = 0 */24 * * *
dispatch.earliest_time = -1d@d
enableSched = 1
search = `get_ot_assets_sw`\
| search asset_criticality=critical\
| timechart span=1d count

[sum_evt_cve_joined_1d]
action.email.useNSSubject = 1
action.keyindicator.invert = 0
action.makestreams.param.verbose = 0
action.nbtstat.param.verbose = 0
action.notable.param.verbose = 0
action.nslookup.param.verbose = 0
action.ping.param.verbose = 0
action.risk.param.verbose = 0
action.send2uba.param.verbose = 0
action.threat_add.param.verbose = 0
alert.track = 0
cron_schedule = 10 0 * * *
dispatch.earliest_time = -1d@d
dispatch.latest_time = -0d@d
display.events.fields = ["host","source","sourcetype","dest_asset","dest_asset_id","dest_asset_model","dest_asset_status","dest_asset_system","dest_asset_tag","dest_asset_type","dest_asset_vendor","dvc_asset","dvc_asset_id","dvc_asset_model","dvc_asset_status","dvc_asset_system","dvc_asset_tag","dvc_asset_type","dvc_asset_vendor","src_asset","src_asset_id","src_asset_model","src_asset_status","src_asset_system","src_asset_tag","src_asset_type","src_asset_vendor","src","dvc_nt_host"]
display.events.type = raw
display.general.type = statistics
display.page.search.mode = verbose
display.page.search.tab = statistics
display.visualizations.chartHeight = 420
display.visualizations.charting.chart = line
display.visualizations.custom.type = network-diagram-viz.network-diagram-viz
display.visualizations.show = 0
enableSched = 1
request.ui_dispatch_app = SplunkEnterpriseSecuritySuite
request.ui_dispatch_view = search
search = `get_latest_vuln(1)`\
| collect index="cve_sum" marker="sum_type=cve_joined_1d"

[evt_sum_ot_asset_traffic_1d]
action.email.useNSSubject = 1
action.keyindicator.invert = 0
action.makestreams.param.verbose = 0
action.nbtstat.param.verbose = 0
action.notable.param.verbose = 0
action.nslookup.param.verbose = 0
action.ping.param.verbose = 0
action.risk.param.verbose = 0
action.send2uba.param.verbose = 0
action.summary_index._name = evt_sum_ot_asset_traffic
action.summary_index.sum_type = evt_sum_ot_asset_traffic_1d
action.threat_add.param.verbose = 0
alert.track = 0
cron_schedule = 5 0 * * *
dispatch.earliest_time = -1d@d
dispatch.latest_time = -0d@d
display.events.fields = ["host","source","sourcetype","lastModifiedDate","cve","cve_prod","description","product_name","vendor_product","ref_url","name","asset_id","asset_model","asset_status","asset_type","asset_type","asset_type","asset_type","asset_type","asset_type","asset_type ","asset_vendor","asset_version","classification","location","exposure","nt_host","ip","zone","priority"]
display.general.type = statistics
display.page.search.mode = verbose
display.page.search.tab = statistics
display.visualizations.charting.chart = bar
display.visualizations.show = 0
enableSched = 1
realtime_schedule = 0
request.ui_dispatch_app = DA-ESS-OTSecurity
request.ui_dispatch_view = search
search = tag=network ( dvc_asset_id=* OR src_asset_id=* OR dest_asset_id=* )\
| stats first(_time) as time_first, last(_time) as time_last, count as tot_session, sum(bytes) as tot_bytes, sum(duration) as tot_duration by src dest  dest_port _time\
| eval dest_port_sum="dest_port="+dest_port+":tot_bytes="+tot_bytes+":duration="+tot_duration\
| eval _time=strftime(_time,"%Y-%m-%d")\
| stats min(time_first) as time_first, max(time_last) as time_last, sum(tot_session) as tot_session, sum(tot_bytes) as tot_bytes, sum(tot_duration) as tot_duration, values(dest_port_sum) as dest_port_sum, dc(dest_port_sum) as tot_port_com_num by _time src dest\
| collect index="evt_sum_ot_asset_traffic" marker="sum_type=evt_sum_ot_asset_traffic_1d"

[Ot_asset - OT Sec - Network Sniffing - Rule]
action.correlationsearch.enabled = 1
action.correlationsearch.label = OT Sec - Network Sniffing
action.customsearchbuilder.enabled = false
action.customsearchbuilder.spec = {}
action.notable = 1
action.notable.param.rule_description = Insecure Network Sniffing activities detected - MITRE ICS SECURITY - T842
action.notable.param.rule_title = OT Sec - Network Sniffing
action.notable.param.security_domain = ot_asset
action.notable.param.severity = high
action.notable.param.verbose = 0
alert.suppress = 1
alert.suppress.fields = dvc
alert.suppress.period = 3600s
alert.track = 1
counttype = number of events
cron_schedule = 0 * * * *
description = OT Sec - Network Sniffing - T842
disabled = 1
dispatch.earliest_time = -60m@m
dispatch.latest_time = -0m@m
dispatch.rt_backfill = 1
enableSched = 1
quantity = 0
realtime_schedule = 0
relation = greater than
request.ui_dispatch_app = SplunkEnterpriseSecuritySuite
search = index=notable ( search_name="Access - Insecure Or Cleartext Authentication - Rule " )\
\
| lookup ot_asset_lookup ip as dest \
| lookup ot_asset_lookup ip as src \
| lookup ot_asset_lookup ip as dvc \
| search ( asset_type="RTU*" OR asset_type="*controller*" ) asset_criticality=*\
\
| stats values(asset_criticality) as asset_criticality, values(asset_type) as asset_type, values(category) as category, values(nt_host) as nt_host, values(location) as location, values(vendor_product) as vendor_product, values(hw_model) as hw_model, values(hw_join) as hw_join, count,  latest(_raw) as "orig_raw" by dvc\


[Ot_asset - OT Sec - User Execution 2 - Rule]
action.correlationsearch.enabled = 1
action.correlationsearch.label = OT Sec - User Execution 2
action.customsearchbuilder.enabled = false
action.customsearchbuilder.spec = {}
action.notable = 1
action.notable.param.rule_description = User Execution activities detected on engineering workstations - MITRE ICS SECURITY -T863
action.notable.param.rule_title = OT Sec - User Execution
action.notable.param.security_domain = ot_asset
action.notable.param.severity = high
action.notable.param.verbose = 0
action.risk = 1
action.risk.param._risk_object = dest
action.risk.param._risk_object_type = system
action.risk.param._risk_score = 10
action.risk.param.verbose = 0
alert.suppress = 1
alert.suppress.fields = dvc
alert.suppress.period = 3600s
alert.track = 1
counttype = number of events
cron_schedule = 0 * * * *
description = OT Sec - User Execution - MITRE ICS SECURITY -T863
disabled = 1
dispatch.earliest_time = -60m@m
dispatch.latest_time = -0m@m
dispatch.rt_backfill = 1
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = SplunkEnterpriseSecuritySuite
search = index=notable ( search_name="Suspicious Email Attachment Extensions"\
OR search_name="Email Attachments With Lots Of Spaces"\
OR search_name="Threat - File Hash Matches - Threat Gen"\
OR search_name="Endpoint Uncleaned Malware Detection"\
OR search_name="Basic Malware Outbreak"\
OR search_name="Multiple Infections on Host"\
OR search_name="Recurring Infection on Host"\
OR search_name="Host With A Recurring Malware Infection"\
OR search_name="Host With Multiple Infections"\
OR search_name="Host With Old Infection Or Potential Re-Infection"\
OR search_name="Ransomware Note Files"\
OR search_name="Ransomware Extensions"\
OR search_name="High Or Critical Priority Host With Malware Detected " )\
| lookup ot_asset_lookup ip as dest \
| lookup ot_asset_lookup ip as src \
| lookup ot_asset_lookup ip as dvc \
| search asset_type="eng* work*" asset_criticality=*\
\
| stats values(asset_criticality) as asset_criticality, values(asset_type) as asset_type, values(category) as category, values(nt_host) as nt_host, values(location) as location, values(vendor_product) as vendor_product, values(hw_model) as hw_model, values(hw_join) as hw_join, count,  latest(_raw) as "orig_raw" by dvc

[Threat - OT Sec - Data Historian Compromise - Rule]
action.correlationsearch.enabled = 1
action.correlationsearch.label = OT Sec - Data Historian Compromise
action.customsearchbuilder.enabled = false
action.customsearchbuilder.spec = {}
action.notable = 1
action.notable.param.rule_description = Potential "Data Historian Compromise" due to detected malware at this endpoint that matches historian asset. MITRE ICS SECURITY -T810
action.notable.param.rule_title = OT Sec - Data Historian Compromise
action.notable.param.security_domain = ot_asset
action.notable.param.severity = critical
action.notable.param.verbose = 0
action.risk = 1
action.risk.param._risk_object = dest
action.risk.param._risk_object_type = system
action.risk.param._risk_score = 10
alert.suppress = 1
alert.suppress.fields = dvc
alert.suppress.period = 216000s
alert.track = 1
counttype = number of events
cron_schedule = */5 * * * *
description = Potential "Data Historian Compromise" due to detected malware at this endpoint that matches historian asset.\
MITRE ICS SECURITY -T810
dispatch.earliest_time = -5m@m
dispatch.latest_time = -0m@m
dispatch.rt_backfill = 1
enableSched = 1
quantity = 0
realtime_schedule = 0
relation = greater than
request.ui_dispatch_app = DA-ESS-OTSecurity
schedule_window = auto
search = index="notable" ( search_name="Endpoint - High Or Critical Priority Host With Malware Detected" OR search_name="Prohibited Software On Endpoint" OR search_name="Host With A Recurring Malware Infection" OR search_name="High Or Critical Priority Host With Malware Detected" OR search_name="High Number of Hosts Not Updating Malware Signatures" OR search_name="Host With Old Infection Or Potential Re-Infection" OR search_name=" Prohibited Software On Endpoint" OR search_name=" Host With A Recurring Malware Infection" OR search_name=" High Or Critical Priority Host With Malware Detected" OR search_name=" Host With Old Infection Or Potential Re-Infection" OR search_name=" Basic Malware Outbreak (SSE)" OR search_name=" Endpoint Uncleaned Malware Detection (SSE)" OR search_name=" Multiple Infections on Host (SSE)" OR search_name=" New Local Admin Account (SSE)" OR search_name=" Recurring Infection on Host (SSE)" OR search_name=" User Login with Local Credentials (SSE)" OR search_name=" Disabled Update Service (SSE)" OR search_name=" Hosts Sending To More Destinations Than Normal (SSE)" OR search_name=" Host With Multiple Infections (ES)" OR search_name=" Outbreak Detected (ES)" OR search_name=" Anomalous Audit Trail Activity Detected (ES)" OR search_name=" Default Account Activity Detected (ES)" OR search_name=" Same Error On Many Servers Detected (ES)" OR search_name=" Substantial Increase In Events (ES)" OR search_name=" Suspicious HTTP Redirects" )\
| lookup ot_asset_lookup ip as dest \
| lookup ot_asset_lookup ip as src \
| lookup ot_asset_lookup ip as dvc \
| search asset_type=historian\
| stats last(infection_count) as infection_count, values(asset_criticality) as asset_criticality, values(asset_type) as asset_type, values(category) as category, values(nt_host) as nt_host, values(location) as location, values(vendor_product) as vendor_product, values(hw_model) as hw_model, values(hw_join) as hw_join, count,  latest(_raw) as "orig_raw" by dvc

[OT Asset - Vulnerability - Published CVEs last 30d]
action.keyindicator = 1
action.keyindicator.delta = count
action.keyindicator.group.0.name = ot_asset_center
action.keyindicator.group.0.order = 2
action.keyindicator.group.1.name = security_posture
action.keyindicator.group.1.order = 2
action.keyindicator.group.2.name = ot_asset_center_02
action.keyindicator.group.2.order = 0
action.keyindicator.group.3.name = OT_Asset_Vulnerability_Updates
action.keyindicator.group.3.order = 0
action.keyindicator.subtitle = Latest published CVEs within 30 days
action.keyindicator.title = OT Asset - Vulnerability - Published CVEs last 30d
action.keyindicator.value = count
cron_schedule = 0 0 * * *
dispatch.earliest_time = -1d@d
enableSched = 1
search = index=cve publishedDate="2020*" OR publishedDate="2021*" OR publishedDate="2022*"\
| rex field=publishedDate "(?P<evt_date>\d{4}-\d{2}-\d{2})"\
| eval time_evt=strptime(publishedDate, "%Y-%m-%d")\
| eval _time=time_evt\
| eval time_now=now()\
| eval time_diff=time_now-time_evt\
| search time_diff<2592000\
| table _time cve time*\
| stats count

[OT Assets - Vulnerability - Latest CVE]
action.keyindicator = 1
action.keyindicator.group.0.name = OT_Asset_Vulnerability_Updates
action.keyindicator.group.0.order = 1
action.keyindicator.subtitle = Last 24 HR
action.keyindicator.title = Latest CVEs Updated
enableSched = false
search = index=cve_sum sum_type=cve_joined_1d earliest=-24h@h latest=+0h@h \
| eval date_epoch_now=now() \
| convert timeformat="%Y-%m-%dT%H:%MZ" mktime(lastModifiedDate) as date_epoch_lastmod \
| eval _time=date_epoch_lastmod \
| eval date_latest_cut_window=date_epoch_now-(86500*3) \
| where _time>date_latest_cut_window \
| search \
| table _time cve vendor product_name version base_score description reference \
| stats count as current_count \
| appendcols \
    [ search index=cve_sum sum_type=cve_joined_1d earliest=-48h@h latest=+24h@h \
    | eval date_epoch_now=now() \
    | convert timeformat="%Y-%m-%dT%H:%MZ" mktime(lastModifiedDate) as date_epoch_lastmod \
    | eval _time=date_epoch_lastmod \
    | eval date_latest_cut_window=date_epoch_now-(86500*3) \
    | where _time>date_latest_cut_window \
    | search \
    | table _time cve vendor product_name version base_score description reference \
    | stats count as historical_count ]\
| `get_ksi_fields(current_count, historical_count)` \
| eval delta=current_count-historical_count\
| table current_count historical_count delta direction

[OT Sec - Total Types of OT Security Alarms]
action.keyindicator = 1
action.keyindicator.delta = count
action.keyindicator.drilldown_uri = 
action.keyindicator.group.0.name = security_posture
action.keyindicator.group.0.order = 4
action.keyindicator.subtitle = Number of different OT Alarms
action.keyindicator.title = OT Sec - Alarms Trends
action.keyindicator.value = count
dispatch.earliest_time = -1d@d
cron_schedule = */30 * * * *
enableSched = true
search = index="notable" search_name="*OT Sec*"\
| timechart count

[OT Assets - Active Notables]
action.keyindicator = 1
action.keyindicator.delta = count
action.keyindicator.drilldown_uri = 
action.keyindicator.group.0.name = OT_Security_Posture
action.keyindicator.group.0.order = 4
action.keyindicator.subtitle = Count of Active Asset Notables
action.keyindicator.title = Active Asset Notables
action.keyindicator.value = count
enableSched = true
cron_schedule = 0 * * * *
dispatch.earliest_time = -1d@d
search = index=notable ( dvc_asset_id="*" OR dest_asset_id="*" OR src_asset_id="*" ) \
| strcat src dest dvc asset\
| timechart dc(search_name) as count

[OT Assets - Risk - Aggregated Risk]
action.keyindicator = 1
action.keyindicator.drilldown_uri = 
action.keyindicator.group.0.name = OT_Security_Posture
action.keyindicator.group.0.order = 0
action.keyindicator.group.1.name = ot_asset_center_02
action.keyindicator.group.1.order = 1
action.keyindicator.subtitle = Sum of Total Risk - Last 24 hr
action.keyindicator.title = Overall Asset Risk Score
cron_schedule = 0 * * * *
dispatch.earliest_time = -1d@d
enableSched = true
search = index=risk earliest=-24h@h latest=+0s \
| eval _time=strftime(_time,"%Y-%m-%d")\
| stats sum(risk_score) as risk_score by _time, risk_object, risk_object_type\
| lookup ot_asset_lookup ip as risk_object \
| lookup cip_asset_lookup ip as risk_object \
| search asset_type=*\
| stats sum(risk_score) as current_count\
| appendcols \
    [ search index=risk earliest=-48h@h latest=-24h@h \
| eval _time=strftime(_time,"%Y-%m-%d")\
| stats sum(risk_score) as risk_score by _time, risk_object, risk_object_type\
| lookup ot_asset_lookup ip as risk_object \
| lookup cip_asset_lookup ip as risk_object \
| search asset_type=*\
| stats sum(risk_score) as historical_count ]\
| `get_ksi_fields(current_count, historical_count)` \
| `get_percentage_qualitative(delta, delta_qual)`

[OT Assets - Active OP Panels]
action.keyindicator = 1
action.keyindicator.delta = count
action.keyindicator.group.0.name = ot_asset_status_search
action.keyindicator.group.0.order = 4
action.keyindicator.subtitle = OT Assets - Total Active OP Panels
action.keyindicator.title = OT Assets - OP Panels
action.keyindicator.value = count
cron_schedule = 0 0 * * *
dispatch.earliest_time = -1d@d
enableSched = 1
search = `get_ot_assets_hw`\
| search asset_type=*operator panel*\
| stats count

[OT Assets - Active Actuators]
action.keyindicator = 1
action.keyindicator.delta = count
action.keyindicator.group.0.name = ot_asset_center_01
action.keyindicator.group.0.order = 4
action.keyindicator.subtitle = OT Assets - Total Active Actuators
action.keyindicator.title = OT Assets - Actuators
action.keyindicator.value = count
cron_schedule = 0 0 * * *
dispatch.earliest_time = -1d@d
enableSched = 1
search = `get_ot_assets_hw`\
| search asset_type=actuator\
| stats count

[OT Assets - Active RTUs]
action.keyindicator = 1
action.keyindicator.delta = count
action.keyindicator.group.0.name = ot_asset_status_search
action.keyindicator.group.0.order = 3
action.keyindicator.group.1.name = ot_asset_center_01
action.keyindicator.group.1.order = 3
action.keyindicator.subtitle = OT Assets - Total Active RTUs
action.keyindicator.title = OT Assets - RTUs
action.keyindicator.value = count
cron_schedule = 0 0 * * *
dispatch.earliest_time = -1d@d
enableSched = 1
search = `get_ot_assets_hw`\
| search asset_type=rtu\
| stats count

[OT Assets - Active PLCs]
action.keyindicator = 1
action.keyindicator.delta = count
action.keyindicator.group.0.name = ot_asset_status_search
action.keyindicator.group.0.order = 2
action.keyindicator.group.1.name = ot_asset_center_01
action.keyindicator.group.1.order = 2
action.keyindicator.subtitle = OT Assets - Total Active PLCs
action.keyindicator.title = OT Assets - PLCs
action.keyindicator.value = count
cron_schedule = 0 0 * * *
dispatch.earliest_time = -1d@d
enableSched = 1
search = `get_ot_assets_hw`\
| search asset_type=plc\
| stats count

[OT Assets - Risk - Avg Score]
action.keyindicator = 1
action.keyindicator.drilldown_uri = 
action.keyindicator.group.0.name = OT_Security_Posture
action.keyindicator.group.0.order = 2
action.keyindicator.group.1.name = ot_asset_center_02
action.keyindicator.group.1.order = 2
action.keyindicator.subtitle = Average of Risk Score per Asset - Last 24 hr
action.keyindicator.title = Per Asset Risk Score
enableSched = false
search = index=risk earliest=-24h@h latest=+0s \
| eval _time=strftime(_time,"%Y-%m-%d")\
| stats sum(risk_score) as risk_score by _time, risk_object, risk_object_type\
| lookup ot_asset_lookup ip as risk_object \
| lookup cip_asset_lookup ip as risk_object \
| search asset_type=*\
| stats avg(risk_score) as current_count\
| appendcols \
    [ search index=risk earliest=-48h@h latest=-24h@h \
| eval _time=strftime(_time,"%Y-%m-%d")\
| stats sum(risk_score) as risk_score by _time, risk_object, risk_object_type\
| lookup ot_asset_lookup ip as risk_object \
| lookup cip_asset_lookup ip as risk_object \
| search asset_type=*\
| stats avg(risk_score) as historical_count ]\
| `get_ksi_fields(current_count, historical_count)` \
| eval delta=current_count-historical_count\
| table current_count historical_count delta direction

[OT Assets - Risk - Host Count]
action.keyindicator = 1
action.keyindicator.drilldown_uri = 
action.keyindicator.group.0.name = OT_Security_Posture
action.keyindicator.group.0.order = 1
action.keyindicator.subtitle = Count of assets with risk - Last 24 hr
action.keyindicator.title = Number of Assets with Risk
enableSched = false
search = index=risk earliest=-24h@h latest=+0s \
| eval _time=strftime(_time,"%Y-%m-%d")\
| stats sum(risk_score) as risk_score by _time, risk_object, risk_object_type\
| lookup ot_asset_lookup ip as risk_object \
| lookup cip_asset_lookup ip as risk_object \
| search asset_type=*\
| stats count as current_count\
| appendcols \
    [ search index=risk earliest=-48h@h latest=-24h@h \
| eval _time=strftime(_time,"%Y-%m-%d")\
| stats sum(risk_score) as risk_score by _time, risk_object, risk_object_type\
| lookup ot_asset_lookup ip as risk_object \
| lookup cip_asset_lookup ip as risk_object \
| search asset_type=*\
| stats count as historical_count ]\
| `get_ksi_fields(current_count, historical_count)` \
| eval delta=current_count-historical_count\
| table current_count historical_count delta direction

[OT Assets - Total Assets]
action.keyindicator = 1
action.keyindicator.drilldown_uri = 
action.keyindicator.group.0.name = ot_asset_center
action.keyindicator.group.0.order = 0
action.keyindicator.group.1.name = security_posture
action.keyindicator.group.1.order = 3
action.keyindicator.group.2.name = ot_asset_status_search
action.keyindicator.group.2.order = 0
action.keyindicator.group.3.name = OT_Security_Posture
action.keyindicator.group.3.order = 3
action.keyindicator.group.4.name = ot_asset_center_01
action.keyindicator.group.4.order = 0
action.keyindicator.subtitle = Total number of assets
action.keyindicator.title = Number of Assets
action.keyindicator.value = count
alert.track = 0
dispatch.earliest_time = -1d@d
cron_schedule = 0 */24 * * *
enableSched = true
search = `get_ot_assets_hw`\
| stats count

[OT Assets - Asset Count with Notables]
action.keyindicator = 1
action.keyindicator.delta = count
action.keyindicator.drilldown_uri = 
action.keyindicator.group.0.name = OT_Security_Posture
action.keyindicator.group.0.order = 5
action.keyindicator.subtitle = Count of Assets with Active Notables
action.keyindicator.title = Assets with Notables
action.keyindicator.value = count
cron_schedule = */30 * * * *
dispatch.earliest_time = -1d@d
enableSched = true
search = index=notable ( dvc_asset_id="*" OR dest_asset_id="*" OR src_asset_id="*" ) \
| strcat src dest dvc asset\
| timechart span=12h dc(asset) as count


#### NERC CIP Section
[Threat - Unapproved removal media use on OT Asset - Rule]
action.correlationsearch.enabled = 1
action.correlationsearch.label = Unapproved removal media use on OT Asset
action.customsearchbuilder.enabled = false
action.customsearchbuilder.spec = {}
action.notable = 1
action.notable.param.drilldown_name = View USB Removable Usage
action.notable.param.drilldown_search = `get_usb_datasources` DeviceType="Removable Storage" | rename ComputerName as nt_host, category as device_category | lookup cip_asset_lookup nt_host OUTPUTNEW priority, category | lookup cip_asset_lookup nt_host as device OUTPUTNEW classification | fillnull classification value="Unapproved" | search (priority="critical" OR priority="high") (classification!=*cip:tca*) | rename nt_host as dvc
action.notable.param.extract_artifacts = {"asset":["dest","dvc"],"identity":["user"]}
action.notable.param.recommended_actions = email,logevent,risk
action.notable.param.rule_description = A host ($dvc$) was detected using removable media on an OT host with $priority$ priority.  Removal Media Device labeled $device$
action.notable.param.rule_title = Unapproved removable media on critical OT asset ($dvc$)
action.notable.param.security_domain = threat
action.notable.param.severity = high
action.notable.param.verbose = 0
alert.suppress = 1
alert.suppress.fields = dvc,device
alert.suppress.period = 60s
alert.track = 1
counttype = number of events
cron_schedule = */5 * * * *
description = Alerting on removable media on a machine that is classified as high or critical using an unapproved removable media device
dispatch.earliest_time = -10m
dispatch.latest_time = now
dispatch.rt_backfill = 1
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = DA-ESS-OTSecurity
search = `get_usb_datasources`  DeviceType="Removable Storage"\
| rename ComputerName as nt_host, category as device_category\
| lookup cip_asset_lookup nt_host OUTPUTNEW priority, category\
| lookup cip_asset_lookup nt_host as device OUTPUTNEW classification\
| fillnull classification value="Unapproved"\
| search (priority="critical" OR priority="high") (classification!=*cip:tca*)\
| rename nt_host as dvc

