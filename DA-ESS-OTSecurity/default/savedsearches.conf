#### OT Security Section

[ot_sec_create_cve_joined]
action.email.useNSSubject = 1
action.keyindicator.invert = 0
action.makestreams.param.verbose = 0
action.nbtstat.param.verbose = 0
action.notable.param.verbose = 0
action.nslookup.param.verbose = 0
action.ping.param.verbose = 0
action.risk.param.verbose = 0
action.send2uba.param.verbose = 0
action.threat_add.param.verbose = 0
alert.track = 0
dispatch.earliest_time = 0
display.general.type = statistics
display.page.search.mode = verbose
display.page.search.tab = statistics
display.visualizations.show = 0
request.ui_dispatch_app = cve_lookup
request.ui_dispatch_view = search
search = `ot_vuln_latest(8000)` \
| stats last(_time) as _time, count, values(description.description_data{}.value) as description, last(lastModifiedDate) as lastModifiedDate by cve sourcetype \
| append \
    [ search index=cve sourcetype=cveproducts \
    | eval cve_prod=cve \
    | stats count values(cve_prod) as cve_prod, values(affects.vendor.vendor_data{}.vendor_name) as vendor_product, values(affects.vendor.vendor_data{}.product.product_data{}.product_name) as product_name by cve sourcetype] \
| append \
    [ search index=cve sourcetype=cvereferences\
| stats values(references.reference_data{}.url) as ref_url by cve sourcetype ]\
| stats last(_time) as _time, count, values(sourcetype) as sourcetype, values(cve_prod) as cve_prod, last(lastModifiedDate) as lastModifiedDate, values(vendor_product) as vendor_product, values(product_name) as product_name, values(description) as description, values(ref_url) as ref_url by cve \
| search count>1 ( vendor_product=siemens OR vendor_product="rockwell*" OR vendor_product="hewlett-packard*" OR vendor_product="schneider*" OR vendor_product="mitsubishi*" OR vendor_product="abb*" OR vendor_product="ge *" OR vendor_product="omron*" OR vendor_product="bosch*" OR vendor_product="beckhoff*" OR vendor_product="fuji*" )\
| table _time cve	count	sourcetype	cve_prod	lastModifiedDate	vendor_product	product_name	description	ref_url\
| collect index=cve_sum marker="sum_type=cve_joined"

[Threat - OT Sec - Valid Accounts - Rule]
action.correlationsearch.enabled = 1
action.correlationsearch.label = OT Sec - Valid Accounts
action.customsearchbuilder.enabled = false
action.customsearchbuilder.spec = {}
action.notable = 1
action.notable.param.rule_description = Default account activity detected on critical OT assets - MITRE ICS SECURITY - T859
action.notable.param.rule_title = OT Sec - Valid Accounts
action.notable.param.security_domain = OT
action.notable.param.severity = high
action.notable.param.verbose = 0
action.risk = 1
action.risk.param._risk_object = dvc
action.risk.param._risk_object_type = system
action.risk.param._risk_score = 200
action.risk.param.verbose = 0
alert.suppress = 1
alert.suppress.fields = dvc
alert.suppress.period = 3600s
alert.track = 1
counttype = number of events
cron_schedule = 0 * * * *
description = Adversaries may steal the credentials of a specific user or service account using credential access techniques. In some cases, default credentials for control system devices may be publicly available. Compromised credentials may be used to bypass access controls placed on various resources on hosts and within the network, and may even be used for persistent access to remote systems.
disabled = 1
dispatch.earliest_time = -60m@m
dispatch.latest_time = -0m@m
dispatch.rt_backfill = 1
enableSched = 1
quantity = 0
realtime_schedule = 0
relation = greater than
request.ui_dispatch_app = SplunkEnterpriseSecuritySuite
search = eventtype=mitre_ics_event technique_id=T859\
| `get_mitre_host_info_mac` \
| append \
    [ search index="notable" ( search_name="* Default Account Activity Detected*" OR search_name="* Default Account At Rest Detected*")\
    | lookup asset_lookup_by_str asset as dest \
    | lookup asset_lookup_by_str asset as src \
    | lookup asset_lookup_by_str asset as dvc \
    | search category="*ot*"]

[Ot_asset - OT Sec - Connection Proxy - Rule]
action.correlationsearch.enabled = 1
action.correlationsearch.label = OT Sec - Connection Proxy
action.customsearchbuilder.enabled = false
action.customsearchbuilder.spec = {}
action.notable = 1
action.notable.param.rule_description = Potential Connection Proxy detected related to critical OT Assets - MITRE ICS SECURITY - T884
action.notable.param.rule_title = OT Sec - Connection Proxy
action.notable.param.security_domain = OT
action.notable.param.severity = high
action.notable.param.verbose = 0
action.risk = 1
action.risk.param.verbose = 0
alert.suppress = 0
alert.track = 1
counttype = number of events
cron_schedule = 0 * * * *
description = Adversaries may use a connection proxy to direct network traffic between systems or act as an intermediary for network communications.
disabled = 1
dispatch.earliest_time = -60m@m
dispatch.latest_time = -0m@m
dispatch.rt_backfill = 1
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = SplunkEnterpriseSecuritySuite
search = eventtype=mitre_ics_event technique_id=T884 \
| `get_mitre_host_info_mac` \
| append \
    [ search index=notable (search_name="*TOR Traffic*"\
        OR search_name="*Detect DNS requests to Phishing Sites*"\
        OR search_name="*Detect Long DNS TXT Record Response*"\
        OR search_name="*Detection of DNS Tunnels*"\
        OR search_name="*Excessive DNS Queries*") \
    | lookup asset_lookup_by_str asset as dest \
    | lookup asset_lookup_by_str asset as src \
    | search category="*ot*" ]

[Ot_asset - OT Sec - Data Destruction - Rule]
action.correlationsearch.enabled = 1
action.correlationsearch.label = OT Sec - Data Destruction
action.customsearchbuilder.enabled = false
action.customsearchbuilder.spec = {}
action.notable = 1
action.notable.param.rule_description = Detected suspicious file deletion activities on $dvc$ - MITRE ICS ATTACK - T809
action.notable.param.rule_title = OT Sec - Data Destruction
action.notable.param.security_domain = OT
action.notable.param.severity = high
action.notable.param.verbose = 0
action.risk = 1
action.risk.param._risk_object = dvc
action.risk.param._risk_object_type = system
action.risk.param._risk_score = 10
action.risk.param.verbose = 0
alert.suppress = 1
alert.suppress.fields = dvc
alert.suppress.period = 3600s
alert.track = 1
counttype = number of events
cron_schedule = 0 * * * *
description = Adversaries may perform data destruction over the course of an operation. The adversary may drop or create malware, tools, or other non-native files on a target system to accomplish this, potentially leaving behind traces of malicious activities.
disabled = 1
dispatch.earliest_time = -60m@m
dispatch.latest_time = -0m@m
dispatch.rt_backfill = 1
enableSched = 1
quantity = 0
realtime_schedule = 0
relation = greater than
request.ui_dispatch_app = SplunkEnterpriseSecuritySuite
search = eventtype=mitre_ics_event technique_id=T809 \
| `get_mitre_host_info_mac` \
| append \
    [ search sourcetype=sysmon Event 23 File Delete \
    | stats values(TargetFilename) as TargetFilename, count, values(Hashes) as Hashes, values(ProcessGuid) as ProcessGuid by host Users \
    | rename host as dvc \
    | lookup asset_lookup_by_str asset as dest \
    | lookup asset_lookup_by_str asset as src \
    | lookup asset_lookup_by_str asset as dvc \
    | search category="*ot*" count>5  ]

[Threat - OT Sec - Exploitation of Remote Services - Rule]
action.correlationsearch.enabled = 1
action.correlationsearch.label = OT Sec - Exploitation of Remote Services
action.customsearchbuilder.enabled = false
action.customsearchbuilder.spec = {}
action.notable = 1
action.notable.param.rule_description = Exploitation of Remote Services detected on $dest$ - MITRE ICS SECURITY - T866
action.notable.param.rule_title = OT Sec - Exploitation of Remote Services
action.notable.param.security_domain = OT
action.notable.param.severity = high
action.notable.param.verbose = 0
action.risk = 1
action.risk.param._risk_object = dest
action.risk.param._risk_object_type = system
action.risk.param._risk_score = 100
action.risk.param.verbose = 0
alert.suppress = 1
alert.suppress.fields = dest
alert.suppress.period = 3600s
alert.track = 1
counttype = number of events
cron_schedule = 0 * * * *
description = Adversaries may exploit a software vulnerability to take advantage of a programming error in a program, service, or within the operating system software or kernel itself to enable remote service abuse.
disabled = 1
dispatch.earliest_time = -60m@m
dispatch.latest_time = -0m@m
dispatch.rt_backfill = 1
enableSched = 1
quantity = 0
realtime_schedule = 0
relation = greater than
request.ui_dispatch_app = SplunkEnterpriseSecuritySuite
search = eventtype=mitre_ics_event technique_id=T866 \
| `get_mitre_host_info_mac` \
| append \
    [| tstats summariesonly=true count from datamodel=Intrusion_Detection.IDS_Attacks where (IDS_Attacks.signature="*smb*") by _time, IDS_Attacks.dest, IDS_Attacks.src, IDS_Attacks.dvc, IDS_Attacks.signature, IDS_Attacks.category \
    | `drop_dm_object_name("IDS_Attacks")` \
    | rename category as ids_category \
    | lookup asset_lookup_by_str asset as dest \
    | lookup asset_lookup_by_str asset as dvc \
    | lookup asset_lookup_by_str asset as src \
    | search category="*ot*"] \
| append \
    [ search index=notables (search_name="*Scheduled tasks used in BadRabbit ransomware*" \
        OR search_name="*Common Ransomware*") \
    | lookup asset_lookup_by_str asset as dest \
    | lookup asset_lookup_by_str asset as dvc \
    | lookup asset_lookup_by_str asset as src \
    | search category="*ot*"]

[Threat - OT Sec - Graphical User Interface - Rule]
action.correlationsearch.enabled = 1
action.correlationsearch.label = OT Sec - Graphical User Interface
action.customsearchbuilder.enabled = false
action.customsearchbuilder.spec = {}
action.notable = 1
action.notable.param.next_steps = {"version":1,"data":"1) Check Host for unauthorized app\n2) Remove apps that uses Remote Desktop"}
action.notable.param.rule_description = Potential remote GUI access to critical OT assets - MITRE ICS SECURITY - T823
action.notable.param.rule_title = OT Sec - Graphical User Interface
action.notable.param.security_domain = OT
action.notable.param.severity = high
action.notable.param.verbose = 0
action.risk = 1
action.risk.param._risk_object = dest
action.risk.param._risk_object_type = system
action.risk.param._risk_score = 100
action.risk.param.verbose = 0
alert.suppress = 1
alert.suppress.fields = dest
alert.suppress.period = 3600s
alert.track = 1
counttype = number of events
cron_schedule = */15 * * * *
description = Adversaries may attempt to gain access to a machine via a Graphical User Interface (GUI) to enhance execution capabilities. Access to a GUI allows a user to interact with a computer in a more visual manner than a CLI.
disabled = 1
dispatch.earliest_time = -60m@m
dispatch.latest_time = -0m@m
dispatch.rt_backfill = 1
enableSched = 1
quantity = 0
realtime_schedule = 0
relation = greater than
request.ui_dispatch_app = SplunkEnterpriseSecuritySuite
search = eventtype=mitre_ics_event technique_id=T823 \
| `get_mitre_host_info_mac` \
| append \
    [| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where (Processes.process=*mstsc.exe* OR Processes.process=*teamviewer* OR Processes.process=*vnc*) by Processes.dest Processes.user Processes.process \
    | `drop_dm_object_name(Processes)` \
    | lookup ot_asset_lookup ip as dest \
    | lookup ot_asset_lookup ip as src \
    | lookup ot_asset_lookup ip as dvc \
    | fillnull dest_category,src_category,dvc_category value="NA" \
    | search dest_category="*ot*" OR src_category="*ot*" OR dvc_category="*ot*" \
    | eval app=process] \
| append \
    [| tstats summariesonly=true count from datamodel=Network_Traffic.All_Traffic where All_Traffic.action="allow*" AND All_Traffic.dest_port=5338 by _time,All_Traffic.dest,All_Traffic.src,All_Traffic.dvc \
    | `drop_dm_object_name("All_Traffic")` \
    | lookup asset_lookup_by_str ip as dvc OUTPUT asset_type as dvc_asset_type \
    | lookup asset_lookup_by_str ip as dest \
    | search category="*ot*" \
    | eval app="teamviewer" ]\
| append \
    [| tstats summariesonly=true count from datamodel=Network_Resolution.DNS WHERE DNS.query="*.teamviewer.com*" by _time,DNS.query,DNS.src \
    | `drop_dm_object_name("DNS")` \
    | lookup ot_asset_lookup ip as src \
    | eval app="teamviewer" ]

[Threat - OT Sec - Masquerading - Rule]
action.correlationsearch.enabled = 1
action.correlationsearch.label = OT Sec - Masquerading
action.customsearchbuilder.enabled = false
action.customsearchbuilder.spec = {}
action.notable = 1
action.notable.param.rule_description = Common process masquerading its id - MITRE ICS SECURITY - T849
action.notable.param.rule_title = Masquerading Activity Detected on $src$ (MITRE ICS)
action.notable.param.security_domain = OT
action.notable.param.severity = high
action.notable.param.verbose = 0
action.risk = 1
action.risk.param._risk_object = dvc
action.risk.param._risk_object_type = system
action.risk.param._risk_score = 10
action.risk.param.verbose = 0
alert.suppress = 1
alert.suppress.fields = src,dest
alert.suppress.period = 3600s
alert.track = 1
counttype = number of events
cron_schedule = */5 * * * *
description = Adversaries may use masquerading to disguise a malicious application or executable as another file, to avoid operator and engineer suspicion. By impersonating expected and vendor-relevant files and applications, operators and engineers may not notice the presence of the underlying malicious content and possibly end up running those masquerading as legitimate functions.
disabled = 1
dispatch.earliest_time = -15m@m
dispatch.latest_time = now
dispatch.rt_backfill = 1
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = SplunkEnterpriseSecuritySuite
search = eventtype=mitre_ics_event technique_id=T849\
| `get_mitre_host_info_mac`\
| append \
    [ search sourcetype=”XmlWinEventLog:Microsoft-Windows-Sysmon/Operational” ( Image=*svchost.exe OR Image=SMSS* OR Image=CSRSS.EXE OR Image=WININIT.EXE OR Image=SERVICES.EXE OR Image=LSASS.EXE OR Image=SVCHOST.EXE OR Image=LSM.EXE OR Image=WINLOGON.EXE OR Image=Explorer.exe ) \
    | eval TIME=strftime(_time,"%Y-%m-%d %H:%M") \
    | eventstats dc(host) as host_cnt_image by Image \
    | stats earliest(TIME) as first_time, values(host) as host, dc(host) as host_cnt, count by Image, Hashes \
    | eval RATIO=(host_cnt/host_cnt_image)*100 \
    | search RATIO<20 \
    | mvexpand host \
    | rename host as dvc \
    | lookup ot_asset_lookup ip as dest \
    | lookup ot_asset_lookup ip as src \
    | lookup ot_asset_lookup ip as dvc \
    | search asset_type=* priority=* ]

[Threat - OT Sec - OT Security Alert - Rule]
action.correlationsearch.enabled = 1
action.correlationsearch.label = OT Sec - Generic OT Security Alert
action.customsearchbuilder.spec = {}
action.keyindicator.invert = 0
action.makestreams.param.verbose = 0
action.nbtstat.param.verbose = 0
action.notable = 1
action.notable.param.extract_artifacts = {"asset":["src","dest","orig_host"],"identity":["src_user","user","src_user_id","src_user_role","user_id","user_role","vendor_account"]}
action.notable.param.rule_description = $description$
action.notable.param.rule_title = $alert_message$
action.notable.param.security_domain = OT
action.notable.param.severity = high
action.notable.param.verbose = 0
action.nslookup.param.verbose = 0
action.ping.param.verbose = 0
action.risk.param.verbose = 0
action.send2uba.param.verbose = 0
action.threat_add.param.verbose = 0
alert.suppress = 1
alert.suppress.fields = alert_message
alert.suppress.period = 10800s
alert.track = 1
counttype = number of events
cron_schedule = */5 * * * *
description = This alert is shown when a generic OT security alert has been generated by an OT Security alert.  OT Security sources are defined in the 'get_ot_security_alerts' macro.  Does not include MITRE ICS attacks
dispatch.earliest_time = -15min
dispatch.latest_time = now
dispatch.rt_backfill = 1
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = SplunkEnterpriseSecuritySuite
search = `get_ot_security_alerts`\
| fillnull technique_id value="Not Mitre"\
| search technique_id="Not Mitre"\
| eval description=if(isnull(description), body, description), signature=if(isnull(signature) OR signature="null", type, signature), dest=if(isnull(dest) OR dest="null", null, dest), src=if(isnull(src) OR src="null", null, src), user=if(isnull(user) OR user="null", null, user), app=if(isnull(app) OR app="null", host, app)\
| eval alert_message=signature + if(isnull(src) OR src="", "", " on " + src) + if(isnull(dest) OR dest="", "", " from " + dest) + " detected by " + app

[Ot_asset - OT Sec - Drive by Compromise - Rule]
action.correlationsearch.enabled = 1
action.correlationsearch.label = OT Sec - Drive by Compromise
action.customsearchbuilder.enabled = false
action.customsearchbuilder.spec = {}
action.notable = 1
action.notable.param.rule_description = Drive by Compromise detected on $dest$ from $src$. MITRE ICS SECURITY -T817
action.notable.param.rule_title = OT Sec - Drive by Compromise
action.notable.param.security_domain = OT
action.notable.param.severity = high
action.notable.param.verbose = 0
action.risk = 1
action.risk.param._risk_object = dvc
action.risk.param._risk_object_type = system
action.risk.param._risk_score = 10
action.risk.param.verbose = 0
alert.suppress = 1
alert.suppress.fields = dest,src
alert.suppress.period = 3600s
alert.track = 1
counttype = number of events
cron_schedule = */5 * * * *
description = Potential "Drive by Compromise" due to detected based on the endpoint activities. MITRE ICS SECURITY -T817
disabled = 1
dispatch.earliest_time = -5m@m
dispatch.latest_time = -0m@m
dispatch.rt_backfill = 1
enableSched = 1
quantity = 0
realtime_schedule = 0
relation = greater than
request.ui_dispatch_app = SplunkEnterpriseSecuritySuite
schedule_window = auto
search = eventtype=mitre_ics_event technique_id=T817\
| `get_mitre_host_info_mac`\
| append [ search index="notable" ( search_name="Endpoint - High Or Critical Priority Host With Malware Detected*") \
| lookup asset_lookup_by_str asset as dest \
| lookup asset_lookup_by_str asset as src \
| lookup asset_lookup_by_src asset as dvc \
| search category=*ot* ]

[Threat - OT Sec - Engineering Workstation Compromise - Rule]
action.correlationsearch.enabled = 1
action.correlationsearch.label = OT Sec - Engineering Workstation Compromise
action.customsearchbuilder.enabled = false
action.customsearchbuilder.spec = {}
action.keyindicator.invert = 0
action.makestreams.param.verbose = 0
action.nbtstat.param.verbose = 0
action.notable = 1
action.notable.param.next_steps = {"version":1,"data":"1) Contact OT asset owner\n2) Create tickets"}
action.notable.param.recommended_actions = email
action.notable.param.rule_description = Potential Engineering Workstation Compromise on $src$. MITRE ICS SECURITY -T818
action.notable.param.rule_title = OT Sec - Engineering Workstation Compromise
action.notable.param.security_domain = OT
action.notable.param.severity = high
action.notable.param.verbose = 0
action.risk = 1
action.risk.param._risk_object = dvc
action.risk.param._risk_object_type = system
action.risk.param._risk_score = 10
action.risk.param.verbose = 0
action.nslookup.param.verbose = 0
action.ping.param.verbose = 0
action.send2uba.param.verbose = 0
action.threat_add.param.verbose = 0
alert.suppress = 1
alert.suppress.fields = dvc,dest,src
alert.suppress.period = 3600s
alert.track = 1
counttype = number of events
cron_schedule = */5 * * * *
description = Potential "Engineering Workstation Compromise" due to detected malware at this endpoint that matches Engineering Workstation Compromise asset.   Assets with asset_type="eng_workstation"\
MITRE ICS SECURITY -T818
disabled = 1
dispatch.earliest_time = -5m@m
dispatch.latest_time = -0m@m
dispatch.rt_backfill = 1
display.general.type = statistics
display.page.search.tab = statistics
enableSched = 1
quantity = 0
realtime_schedule = 0
relation = greater than
request.ui_dispatch_app = DA-ESS-OTSecurity
schedule_window = auto
search = eventtype=mitre_ics_event technique_id=T818 \
| `get_mitre_host_info_mac` \
| append \
    [ search index="notable" ( search_name="*Host With Multiple Infections*" OR search_name="*High Or Critical Priority Host With Malware Detected*" OR search_name="*Prohibited Software On Endpoint*" OR search_name="*Host With A Recurring Malware Infection" OR search_name="*High Or Critical Priority Host With Malware Detected*" OR search_name="*High Number of Hosts Not Updating Malware Signatures*" OR search_name="*Host With Old Infection Or Potential Re-Infection*" OR search_name="*Prohibited Software On Endpoint*" OR search_name="*Host With A Recurring Malware Infection*" OR search_name="*High Or Critical Priority Host With Malware Detected*" OR search_name="*Host With Old Infection Or Potential Re-Infection*" OR search_name="*Basic Malware Outbreak (SSE)*" OR search_name="*Endpoint Uncleaned Malware Detection (SSE)*" OR search_name="*Multiple Infections on Host (SSE)*" OR search_name="*New Local Admin Account (SSE)*" OR search_name="*Recurring Infection on Host (SSE)*" OR search_name="*User Login with Local Credentials (SSE)*" OR search_name="*Disabled Update Service (SSE)*" OR search_name="*Hosts Sending To More Destinations Than Normal (SSE)*" OR search_name="*Host With Multiple Infections (ES)*" OR search_name="*Outbreak Detected (ES)*" OR search_name="*Anomalous Audit Trail Activity Detected (ES)*" OR search_name="*Default Account Activity Detected (ES)*" OR search_name="*Same Error On Many Servers Detected (ES)*" OR search_name="*Substantial Increase In Events (ES)*" OR search_name="*Suspicious HTTP Redirects*" ) \
    | lookup asset_lookup_by_str ip as src OUTPUTNEW asset_type as src_asset_type, asset_status as src_asset_status, asset_system as src_asset_system, site_id as src_site_id, zone as src_zone, classification as src_classification, bunit as src_bunit, nt_host as src_nt_host, category as src_category, city as src_city, country as src_country, lat as src_lat, long as src_long, ip as src_ip, dns as src_dns \
    | lookup asset_lookup_by_str ip as dest OUTPUTNEW asset_type as dest_asset_type, asset_status as dest_asset_status, asset_system as dest_asset_system, site_id as dest_site_id, zone as dest_zone, classification as dest_classification, bunit as dest_bunit, nt_host as dest_nt_host, category as dest_category, city as dest_city, country as dest_country, lat as dest_lat, long as dest_long, ip as dest_ip, dns as dest_dns \
    | search dest_asset_type="eng_ws" OR src_asset_type="eng_ws" \
    | table _time,dest,body,src,app,severity,type,dvc,src_*,dest_* ]


[Threat - OT Sec - Exploit Public-Facing Application - Rule]
action.correlationsearch.enabled = 1
action.correlationsearch.label = OT Sec - Exploit Public-Facing Application
action.customsearchbuilder.enabled = false
action.customsearchbuilder.spec = {}
action.notable = 1
action.notable.param.next_steps = {"version":1,"data":"1) Check traffic sessions"}
action.notable.param.rule_description = Potential public facing application detected though network traffic sessions out from outside network by $dvc$. MITRE ICS SECURITY -T819
action.notable.param.rule_title = OT Sec - Exploit Public-Facing Application
action.notable.param.security_domain = OT
action.notable.param.severity = medium
action.notable.param.verbose = 0
action.risk = 1
action.risk.param._risk_object = dest_ip
action.risk.param._risk_object_type = system
action.risk.param._risk_score = 100
action.risk.param.verbose = 0
alert.suppress = 1
alert.suppress.fields = dvc,dest,dest_port,src
alert.suppress.period = 60s
alert.track = 1
counttype = number of events
cron_schedule = */5 * * * *
disabled = 1
dispatch.earliest_time = -10m@m
dispatch.latest_time = now
dispatch.rt_backfill = 1
description = Potential public facing application detected though network traffic sessions out from outside network. MITRE ICS SECURITY -T819
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = SplunkEnterpriseSecuritySuite
search = eventtype=mitre_ics_event technique_id=T819 \
| `get_mitre_host_info_mac` \
| append \
    [ search index="notable" (search_name="*Prohibited Network Traffic*"\
        OR search_name="*Prohibited Port Activity Detected*"\
        OR search_name="*Unapproved port activity detected*") dest_port=80 OR dest_port=443 ] \
| append \
    [ search index="notable" (search_name="Excessive HTTP Failure Responses"\
        OR search_name="Abnormally High Number of HTTP Method Events By Src" ) \
    | rename host as dvc \
    | lookup ot_asset_lookup ip as dest \
    | lookup ot_asset_lookup ip as src \
    | lookup ot_asset_lookup ip as dvc \
    | fillnull dest_category,src_category,dvc_category value="NA" \
    | search dest_category="*ot*" OR src_category="*ot*" OR dvc_category="*ot*"]


[Threat - OT Sec - External Remote Services - Rule]
action.correlationsearch.enabled = 1
action.correlationsearch.label = OT Sec - External Remote Services
action.customsearchbuilder.enabled = false
action.customsearchbuilder.spec = {}
action.notable = 1
action.notable.param.rule_description = External Remote Services like SMB, RDP, VNC detected from VPN remote services on OT assets - MITRE ICS SECURITY -  T822
action.notable.param.rule_title = OT Sec - External Remote Services
action.notable.param.security_domain = OT
action.notable.param.severity = high
action.notable.param.verbose = 0
action.risk = 1
action.risk.param._risk_object = dest
action.risk.param._risk_object_type = system
action.risk.param._risk_score = 100
action.risk.param.verbose = 0
alert.suppress = 1
alert.suppress.fields = dest
alert.suppress.period = 3600s
alert.track = 1
counttype = number of events
cron_schedule = */5 * * * *
description = OT Sec - External Remote Services
disabled = 1
dispatch.earliest_time = -10m@m
dispatch.latest_time = now
dispatch.rt_backfill = 1
enableSched = 1
quantity = 0
realtime_schedule = 0
relation = greater than
request.ui_dispatch_app = SplunkEnterpriseSecuritySuite
search = eventtype=mitre_ics_event technique_id=T822\
| `get_mitre_host_info_mac` \
| append \
    [ search index="notable" (search_name="*Detect Outbound SMB Traffic*"\
    OR search_name="Remote Desktop Network*")\
    | lookup ot_asset_lookup nt_host as dest OUTPUT category as dest_category, asset_type as dest_asset_type, ip as dest_ip, mac as dest_mac, dns as dest_mac, site_id as dest_site_id, asset_system as dest_asset_system\
    | lookup ot_asset_lookup nt_host as src OUTPUT category as src_category, asset_type as src_asset_type, ip as src_ip, mac as src_mac, dns as src_mac, site_id as src_site_id, asset_system as src_asset_system\
    | lookup ot_asset_lookup nt_host as dvc OUTPUT category as dvc_category, asset_type as dvc_asset_type, ip as dvc_ip, mac as dvc_mac, dns as dvc_mac, site_id as dvc_site_id, asset_system as dvc_asset_system\
    | search category="*ot*" OR src_category="*ot*" OR dest_category="*OT*" OR dvc_category="*ot*"\
    ] \
| append \
    [ search index="notable" ( \
        search_name="*Excessive HTTP Failure Responses*"\
        OR search_name="*Abnormally High Number of HTTP Method Events By Src*" ) \
    | rename host as dvc \
    | lookup ot_asset_lookup nt_host as dest OUTPUT category as dest_category, asset_type as dest_asset_type, ip as dest_ip, mac as dest_mac, dns as dest_mac, site_id as dest_site_id, asset_system as dest_asset_system\
    | lookup ot_asset_lookup nt_host as src OUTPUT category as src_category, asset_type as src_asset_type, ip as src_ip, mac as src_mac, dns as src_mac, site_id as src_site_id, asset_system as src_asset_system\
    | lookup ot_asset_lookup nt_host as dvc OUTPUT category as dvc_category, asset_type as dvc_asset_type, ip as dvc_ip, mac as dvc_mac, dns as dvc_mac, site_id as dvc_site_id, asset_system as dvc_asset_system\
    | fillnull category, src_category, dvc_category, dest_category value="NA"\
    | search category="*ot*" OR src_category="*ot*" OR dest_category="*OT*" OR dvc_category="*ot*" ]

[Threat - OT Sec - Internet Accessible Device - Rule]
action.correlationsearch.enabled = 1
action.correlationsearch.label = OT Sec - Internet Accessible Device
action.customsearchbuilder.enabled = false
action.customsearchbuilder.spec = {}
action.notable = 1
action.notable.param.recommended_actions = email
action.notable.param.rule_description = Potential host direct connection to OT assets via Internet - MITRE ICS SECURITY -T883action.notable.param.rule_description = Potential host direct connection to OT assets via Internet - MITRE ICS SECURITY -T883
action.notable.param.rule_title = OT Sec - Internet Accessible Device
action.notable.param.security_domain = OT
action.notable.param.severity = high
action.notable.param.verbose = 0
action.risk = 1
action.risk.param._risk_object = dest
action.risk.param._risk_object_type = system
action.risk.param._risk_score = 100
action.risk.param.verbose = 0
alert.suppress = 1
alert.suppress.fields = src,dvc
alert.suppress.period = 3600s
alert.track = 1
counttype = number of events
cron_schedule = */10 * * * *
description = Adversaries may gain access into industrial environments directly through systems exposed to the internet for remote access rather than through External Remote Services.
disabled = 1
dispatch.earliest_time = -10m@m
dispatch.latest_time = -0m@m
dispatch.rt_backfill = 1
enableSched = 1
quantity = 0
realtime_schedule = 0
relation = greater than
request.ui_dispatch_app = DA-ESS-OTSecurity
search = eventtype=mitre_ics_event technique_id=T883 \
| `get_mitre_host_info_mac` \
| append \
    [| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Network_Traffic where All_Traffic.action=allowed AND (All_Traffic.dest_port=80 OR All_Traffic.dest_port=443) by All_Traffic.src_ip All_Traffic.dest_ip All_Traffic.dest_port All_Traffic.action,_time \
    | lookup update=true interesting_ports_lookup dest_port as All_Traffic.dest_port OUTPUT app is_prohibited note transport \
    | `security_content_ctime(firstTime)` \
    | `security_content_ctime(lastTime)` \
    | `drop_dm_object_name("All_Traffic")` \
    | lookup asset_lookup_by_str ip as src_ip OUTPUTNEW category as src_asset_category \
    | search src_asset_category="ot*" \
    | rename dest_ip as dest, src_ip as src, host as dvc]


[Threat - OT Sec - Replication Through Removable Media - Rule]
action.correlationsearch.enabled = 1
action.correlationsearch.label = OT Sec - Replication Through Removable Media
action.customsearchbuilder.enabled = false
action.customsearchbuilder.spec = {}
action.notable = 1
action.notable.param.rule_description = Removable media detected on $dest$ - Potential Replication Through Removable Media MITRE ICS SECURITY -T847
action.notable.param.rule_title = OT Sec - Replication Through Removable Media
action.notable.param.security_domain = OT
action.notable.param.severity = high
action.notable.param.verbose = 0
action.risk = 1
action.risk.param._risk_object = dvc
action.risk.param._risk_object_type = system
action.risk.param._risk_score = 10
action.risk.param.verbose = 0
alert.suppress = 1
alert.suppress.fields = dest
alert.suppress.period = 3600s
alert.track = 1
counttype = number of events
cron_schedule = */10 * * * *
description = OT Sec - Replication Through Removable Media.  Setup: Update the get_usb_datasources macros to define your own sourWces for removable media events.  Setup: Define your own source for endpoint media detection
disabled = 1
dispatch.earliest_time = -10m@m
dispatch.latest_time = -0m@m
dispatch.rt_backfill = 1
enableSched = 1
quantity = 0
realtime_schedule = 0
relation = greater than
request.ui_dispatch_app = DA-ESS-OTSecurity
search = eventtype=mitre_ics_event technique_id=T847 \
| `get_mitre_host_info_mac` \
| append \
    [ search `get_usb_datasources` \
    | lookup asset_lookup_by_str asset as dvc \
    | lookup asset_lookup_by_str asset as src \
    | lookup asset_lookup_by_str asset as dest \
    | search category="*ot*"] \
| append \
    [ search index=notable search_name="*Detect USB device insertion*" \
    | lookup asset_lookup_by_str asset as dvc \
    | lookup asset_lookup_by_str asset as src \
    | lookup asset_lookup_by_str asset as dest \
    | search category="*ot*"]

[Threat - OT Sec - Spearphishing Attachment related activity - Rule]
action.correlationsearch.enabled = 1
action.correlationsearch.label = OT Sec - Spearphishing Attachment related activity
action.customsearchbuilder.enabled = false
action.customsearchbuilder.spec = {}
action.notable = 1
action.notable.param.rule_description = Potential Spearphishing activity detected on $src$ - MITRE ICS SECURITY -T865
action.notable.param.rule_title = OT Sec - Spearphishing Attachment related activity
action.notable.param.security_domain = OT
action.notable.param.severity = high
action.notable.param.verbose = 0
action.risk = 1
action.risk.param._risk_object = src
action.risk.param._risk_object_type = system
action.risk.param._risk_score = 100
action.risk.param.verbose = 0
alert.suppress = 1
alert.suppress.fields = src
alert.suppress.period = 3600s
alert.track = 1
counttype = number of events
cron_schedule = */5 * * * *
description = OT Sec - Spearphishing Attachment related activity : Customize Time Range
disabled = 1
dispatch.earliest_time = -15m@m
dispatch.latest_time = now
dispatch.rt_backfill = 1
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = SplunkEnterpriseSecuritySuite
search = eventtype=mitre_ics_event technique_id=T865 \
| `get_mitre_host_info_mac` \
| append \
    [ search index="notable" \
        (search_name="Detect DNS requests to Phishing Sites "\
        OR search_name="*Detect Oulook.exe writing a .zip file*"\
        OR search_name="*Suspicious LNK file launching a process*"\
        OR search_name="*Detect DNS requests to Phishing Sites leveraging EvilGinx2*"\
        OR search_name="*Basic Malware Outbreak (SSE)*"\
        OR search_name="*Recurring Infection on Host (SSE)*"\
        OR search_name="*Endpoint Uncleaned Malware Detection (SSE)*"\
        OR search_name="*Multiple Infections on Host (SSE)*"\
        OR search_name="*Host With Multiple Infections (ES)*"\
        OR search_name="*Email with attachmet with long spaces (SSE)*"\
        OR search_name="*Dynamic DNS ESCU - web traffic to ddns*"\
        OR search_name="*Ddns activity detected*"\
        OR search_name="*Automatic Domain Generated Algorhithm detected (UBA)*" \
        OR search_name="*Common Phishing Frameworks" \
        OR search_name="*Phishing Payloads*"\
        ) \
    | lookup ot_asset_lookup ip as dest \
    | lookup ot_asset_lookup ip as src \
    | lookup ot_asset_lookup ip as dvc \
    | fillnull dest_category, src_category, dvc_category value="NA" \
    | search dest_category="*ot*" OR src_category="*pt*" OR dvc_category="*ot*"]

[Threat - OT Sec - Command-Line Interface - Rule]
action.correlationsearch.enabled = 1
action.correlationsearch.label = OT Sec - Command-Line Interface
action.customsearchbuilder.enabled = false
action.customsearchbuilder.spec = {}
action.notable = 1
action.notable.param.rule_description = Potential Command-Line Interface activity detected at the Endpoint - MITRE ICS SECURITY -T807
action.notable.param.rule_title = OT Sec - Command-Line Interface
action.notable.param.security_domain = OT
action.notable.param.severity = high
action.notable.param.verbose = 0
action.risk = 1
action.risk.param._risk_object = dvc
action.risk.param._risk_object_type = system
action.risk.param._risk_score = 100
action.risk.param.verbose = 0
alert.suppress = 1
alert.suppress.fields = dvc
alert.suppress.period = 3600s
alert.track = 1
counttype = number of events
cron_schedule = 0 * * * *
description = OT Sec - Command-Line Interface: T807
disabled = 1
dispatch.earliest_time = -60m@m
dispatch.latest_time = -0m@m
dispatch.rt_backfill = 1
enableSched = 1
quantity = 0
realtime_schedule = 0
relation = greater than
request.ui_dispatch_app = SplunkEnterpriseSecuritySuite
search = eventtype=mitre_ics_event technique_id=T883 \
| `get_mitre_host_info_mac` \
| append \
    [| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Network_Traffic where All_Traffic.action=allowed AND (All_Traffic.dest_port=80 OR All_Traffic.dest_port=443) by All_Traffic.src_ip All_Traffic.dest_ip All_Traffic.dest_port All_Traffic.action,_time \
    | lookup update=true interesting_ports_lookup dest_port as All_Traffic.dest_port OUTPUT app is_prohibited note transport \
    | `drop_dm_object_name("All_Traffic")` \
    | lookup asset_lookup_by_str ip as src_ip OUTPUTNEW category as src_asset_category \
    | search dest_asset_category="*ot*" `exclude_internal_ips(src)` \
    | rename dest_ip as dest, src_ip as src, host as dvc ]\
| append \
    [ search index=notable search_name="*Malicious PowerShell Process - Connect To Internet With Hidden Window*" \
    | lookup ot_asset_lookup ip as dest \
    | lookup ot_asset_lookup ip as src \
    | lookup ot_asset_lookup ip as dvc \
    | fillnull dest_category, src_category, dvc_category value="NA" \
    | search dest_category="*ot*" OR src_category="*ot*" OR dvc_category="*ot*" ]


[Threat - OT Sec - Scripting - Rule]
action.correlationsearch.enabled = 1
action.correlationsearch.label = OT Sec - Scripting
action.customsearchbuilder.enabled = false
action.customsearchbuilder.spec = {}
action.notable = 1
action.notable.param.rule_description = Suspicious Scripting Activity Detected on engineering workstations - MITRE ICS SECURITY -  T853
action.notable.param.rule_title = OT Sec - Scripting
action.notable.param.security_domain = OT
action.notable.param.severity = high
action.notable.param.verbose = 0
action.risk = 1
action.risk.param._risk_object = dvc
action.risk.param._risk_object_type = system
action.risk.param._risk_score = 100
action.risk.param.verbose = 0
alert.suppress = 1
alert.suppress.fields = dvc,src
alert.suppress.period = 3600s
alert.track = 1
counttype = number of events
cron_schedule = 0 * * * *
description = Adversaries may use scripting languages to execute arbitrary code in the form of a pre-written script or in the form of user-supplied code to an interpreter.
disabled = 1
dispatch.earliest_time = -60m@m
dispatch.latest_time = -0m@m
dispatch.rt_backfill = 1
enableSched = 1
quantity = 0
realtime_schedule = 0
relation = greater than
request.ui_dispatch_app = SplunkEnterpriseSecuritySuite
search = eventtype=mitre_ics_event technique_id=T853 \
| `get_mitre_host_info_mac` \
| append \
    [ search index=notable ( search_name="*Malicious PowerShell Process - Connect To Internet With Hidden Window*"\
        OR search_name="*Malicious PowerShell Process - Encoded Command*"\
        OR search_name="*Malicious PowerShell Process - Execution Policy Bypass*"\
        OR search_name="*Malicious PowerShell Process - Multiple Suspicious Command-Line Arguments*"\
        OR search_name="*Malicious PowerShell Process With Obfuscation Techniques*"\
        OR search_name="*Remote Desktop Process Running On System*"\
        OR search_name="*Remote Process Instantiation via WMI*"\
        OR search_name="*Prohibited Process Detected*"\
        OR search_name="*Attempt To Set Default PowerShell Execution Policy To Unrestricted or Bypass*"\
        OR search_name="*First time seen command line argument*" ) \
    | lookup ot_asset_lookup ip as dest \
    | lookup ot_asset_lookup ip as src \
    | lookup ot_asset_lookup ip as dvc \
    | fillnull dest_category,src_category,dvc_category value="NA" \
    | search dest_category="*ot*" OR src_category="*ot*" OR dvc_category="*ot*"]

[Threat - OT Sec - User Execution - Rule]
action.correlationsearch.enabled = 1
action.correlationsearch.label = OT Sec - User Execution
action.customsearchbuilder.enabled = false
action.customsearchbuilder.spec = {}
action.notable = 1
action.notable.param.rule_description = Malicious files executed at the endpoint - MITRE ICS SECURITY -T863
action.notable.param.rule_title = OT Sec - User Execution
action.notable.param.security_domain = OT
action.notable.param.severity = high
action.notable.param.verbose = 0
action.risk = 1
action.risk.param._risk_object = dvc
action.risk.param._risk_object_type = system
action.risk.param._risk_score = 100
action.risk.param.verbose = 0
alert.suppress = 1
alert.suppress.fields = dvc
alert.suppress.period = 3600s
alert.track = 1
counttype = number of events
cron_schedule = 0 * * * *
description = Adversaries may rely on a targeted organizations’ user interaction for the execution of malicious code. User interaction may consist of installing applications, opening email attachments, or granting higher permissions to documents.
disabled = 1
dispatch.earliest_time = -60m@m
dispatch.latest_time = -0m@m
dispatch.rt_backfill = 1
enableSched = 1
quantity = 0
realtime_schedule = 0
relation = greater than
request.ui_dispatch_app = SplunkEnterpriseSecuritySuite
search = index=notable ( search_name="Suspicious Email Attachment Extensions"\
OR search_name="Email Attachments With Lots Of Spaces"\
OR search_name="Threat - File Hash Matches - Threat Gen"\
OR search_name="Endpoint Uncleaned Malware Detection"\
OR search_name="Basic Malware Outbreak"\
OR search_name="Multiple Infections on Host"\
OR search_name="Recurring Infection on Host"\
OR search_name="Host With A Recurring Malware Infection"\
OR search_name="Host With Multiple Infections"\
OR search_name="Host With Old Infection Or Potential Re-Infection"\
OR search_name="Ransomware Note Files"\
OR search_name="Ransomware Extensions"\
OR search_name="High Or Critical Priority Host With Malware Detected " )\
| lookup ot_asset_lookup ip as dest \
| lookup ot_asset_lookup ip as src \
| lookup ot_asset_lookup ip as dvc \
| search asset_type="eng* work*" asset_criticality=*\
\
| stats values(asset_criticality) as asset_criticality, values(asset_type) as asset_type, values(category) as category, values(nt_host) as nt_host, values(location) as location, values(vendor_product) as vendor_product, values(hw_model) as hw_model, values(hw_join) as hw_join, count,  latest(_raw) as "orig_raw" by dvc

[Threat - OT Sec - Network Service Scanning - Rule]
action.correlationsearch.enabled = 1
action.correlationsearch.label = OT Sec - Network Service Scanning
action.customsearchbuilder.enabled = false
action.customsearchbuilder.spec = {}
action.notable = 1
action.notable.param.rule_description = Network scanning activities detected targeting OT assets - MITRE ICS SECURITY - T841
action.notable.param.rule_title = OT Sec - Network Service Scanning
action.notable.param.security_domain = OT
action.notable.param.severity = high
action.notable.param.verbose = 0
action.risk = 1
action.risk.param._risk_object = dest
action.risk.param._risk_object_type = system
action.risk.param._risk_score = 100
action.risk.param.verbose = 0
alert.suppress = 1
alert.suppress.fields = dest
alert.suppress.period = 3600s
alert.track = 1
counttype = number of events
cron_schedule = 0 * * * *
description = OT Sec - Network Service Scanning
disabled = 1
dispatch.earliest_time = -60m@m
dispatch.latest_time = -0m@m
dispatch.rt_backfill = 1
enableSched = 1
quantity = 0
realtime_schedule = 0
relation = greater than
request.ui_dispatch_app = SplunkEnterpriseSecuritySuite
search = eventtype=mitre_ics_event technique_id=T841\
| `get_mitre_host_info_mac` \
| append \
    [ search index=notable ( search_name="*Hosts Sending To More Destinations Than Normal*"\
        OR search_name="*Unauthorized Connection Through Firewall*"\
        OR search_name="*Basic Scanning*"\
        OR search_name="*Unrouteable Activity Detected*"\
        OR search_name="*Concentration of Attacker Tools by Filename*"\
        OR search_name="*Vulnerability Scanner Detected (by events)*"\
        OR search_name="*Vulnerability Scanner Detected (by targets)*"\
        OR search_name="*Scanning Activity (UBA)*" ) \
    | lookup ot_asset_lookup ip as dest \
    | lookup ot_asset_lookup ip as src \
    | lookup ot_asset_lookup ip as dvc \
    | fillnull dest_category, src_category, dvc_category value="NA" \
    | search dest_category="*ot*" OR src_category="*ot*" OR dvc_category="*ot*" ]

[Threat - OT Sec - Remote System Discovery - Rule]
action.correlationsearch.enabled = 1
action.correlationsearch.label = OT Sec - Remote System Discovery
action.customsearchbuilder.enabled = false
action.customsearchbuilder.spec = {}
action.notable = 1
action.notable.param.rule_description = Detected remote discovery activities on $src$ - MITRE ICS SECURITY - T846
action.notable.param.rule_title = OT Sec - Remote System Discovery
action.notable.param.security_domain = OT
action.notable.param.severity = high
action.notable.param.verbose = 0
action.risk = 1
action.risk.param._risk_object = dest
action.risk.param._risk_object_type = system
action.risk.param._risk_score = 10
action.risk.param.verbose = 0
alert.suppress = 1
alert.suppress.fields = src
alert.suppress.period = 3600s
alert.track = 1
counttype = number of events
cron_schedule = */5 * * * *
description = OT Sec - Remote System Discovery - Monitor network scanning activities that attemps to map targets, like PLCs
disabled = 1
dispatch.earliest_time = -60m@m
dispatch.latest_time = now
dispatch.rt_backfill = 1
enableSched = 1
quantity = 0
realtime_schedule = 0
relation = greater than
request.ui_dispatch_app = SplunkEnterpriseSecuritySuite
search = eventtype=mitre_ics_event technique_id=T846 \
| `get_mitre_host_info_mac` \
| append \
    [| tstats `summariesonly` values(All_Traffic.action) as action,values(All_Traffic.src_port) as src_port,values(All_Traffic.dest_port) as dest_port,dc(All_Traffic.dest_port) as dest_port_cnt, dc(All_Traffic.dest) as dest_ip_cnt, values(All_Traffic.dest) as dest_ip_list,count from datamodel=Network_Traffic.All_Traffic where (All_Traffic.src="*" OR All_Traffic.src_ip="*" OR All_Traffic.src_mac="*" OR All_Traffic.src_translated_ip="*") (All_Traffic.dest="*" OR All_Traffic.dest_ip="*" OR All_Traffic.dest_mac="*" OR All_Traffic.dest_translated_ip="*") by All_Traffic.src,All_Traffic.dest,_time \
    | `drop_dm_object_name("All_Traffic")` \
    | bin _time span=1h \
    | stats dc(dest_port) as count_by_port dc(dest) as count_by_dest by src \
    | where count_by_port > 1024 AND count_by_dest > 100 \
    | lookup asset_lookup_by_str asset as src \
    | lookup asset_lookup_by_str asset as dvc \
    | lookup asset_lookup_by_str asset as dest \
    | search category="*ot*" `get_ot_device_asset_types(asset_type)` ] \
| append \
    [ search index=notable (search_name="*System Information Discovery Detection*") \
    | lookup asset_lookup_by_str asset as src \
    | lookup asset_lookup_by_str asset as dvc \
    | lookup asset_lookup_by_str asset as dest \
    | search category="*ot*" `get_ot_device_asset_types(asset_type)` ]

[Threat - OT Sec - Remote File Copy - Rule]
action.correlationsearch.enabled = 1
action.correlationsearch.label = OT Sec - Remote File Copy
action.customsearchbuilder.enabled = false
action.customsearchbuilder.spec = {}
action.notable = 1
action.notable.param.rule_description = Network Transfers using Remote File Copy (SMB) 1mb over detected - MITRE ICS SECURITY - 867
action.notable.param.rule_title = OT Sec - Remote File Copy
action.notable.param.security_domain = OT
action.notable.param.severity = high
action.notable.param.verbose = 0
action.risk = 1
action.risk.param._risk_object = dest
action.risk.param._risk_object_type = system
action.risk.param._risk_score = 100
action.risk.param.verbose = 0
alert.suppress = 1
alert.suppress.fields = dest,src
alert.suppress.period = 3600s
alert.track = 1
counttype = number of events
cron_schedule = */15 * * * *
description = OT Sec - Remote File Copy- - Detecting file transfer activites through services like SMB,FTP and others to spread attack assets to other hosts(ot OT assets) in the network
disabled = 1
dispatch.earliest_time = -60m@m
dispatch.latest_time = now
dispatch.rt_backfill = 1
enableSched = 1
quantity = 0
realtime_schedule = 0
relation = greater than
request.ui_dispatch_app = SplunkEnterpriseSecuritySuite
search = eventtype=mitre_ics_event technique_id=T867 \
| `get_mitre_host_info_mac`\
| append \
    [ search index=notable ( search_name="*Spike in SMB Traffic*"\
        OR search_name="*Suspicious Network Connection (UBA)*"\
        OR search_name="*Suspicious Network Exploration (UBA)*" \
        OR search_name="*Scheduled tasks used in BadRabbit ransomware*" ) \
    | lookup asset_lookup_by_str asset as dest \
    | lookup asset_lookup_by_str asset as dest  \
    | lookup asset_lookup_by_str asset as dest  \
    | search category="*ot*" ]


[Threat - OT Sec - Data from Information Repositories - Rule]
action.correlationsearch.enabled = 1
action.correlationsearch.label = OT Sec - Data from Information Repositories
action.customsearchbuilder.enabled = false
action.customsearchbuilder.spec = {}
action.notable = 1
action.notable.param.rule_description = Suspicious activities from OT assets access Data from Information Repositories - MITRE ICS SECURITY - T811
action.notable.param.rule_title = OT Sec - Data from Information Repositories
action.notable.param.security_domain = OT
action.notable.param.severity = high
action.notable.param.verbose = 0
action.risk = 1
action.risk.param._risk_object = dvc
action.risk.param._risk_object_type = system
action.risk.param._risk_score = 100
action.risk.param.verbose = 0
alert.suppress = 1
alert.suppress.fields = dvc
alert.suppress.period = 3600s
alert.track = 1
counttype = number of events
cron_schedule = 0 * * * *
description = Adversaries may target and collect data from information repositories. This can include sensitive data such as specifications, schematics, or diagrams of control system layouts, devices, and processes. Examples of target information repositories include reference databases and local machines on the process environment.
disabled = 1
dispatch.earliest_time = -60m@m
dispatch.latest_time = -0m@m
dispatch.rt_backfill = 1
enableSched = 1
quantity = 0
realtime_schedule = 0
relation = greater than
request.ui_dispatch_app = SplunkEnterpriseSecuritySuite
search = eventtype=mitre_ics_event technique_id=T811 \
| `get_mitre_host_info_mac` \
| append \
    [ search index=notable ( search_name="*Hiding Files and Directories with Attrib exe*"\
        OR search_name="*First Time Accessing an Internal Git Repository*"\
        OR search_name="*First Time Accessing an Internal Git Repository Not Viewed by Peers*"\
        OR search_name="*User Finding Project Code Names from Many Departments*"\
        OR search_name="*Download from Internal Server*"\
        OR search_name="*Suspicious Data Movement*"\
        OR search_name="*SMB Traffic Spike*") \
    | lookup asset_lookup_by_str asset as dest \
    | lookup asset_lookup_by_str asset as src \
    | lookup asset_lookup_by_str asset as dvc \
    | search category="*ot*" ] \
| append \
    [| tstats summariesonly=true values(DLP.object) as files values(DLP.object_path) from datamodel=DLP.DLP_Incidents where DLP.object="*.dwg" OR DLP.object_path="*design*" by _time,DLP.user,DLP.src,DLP.dest,DLP.dvc \
    | `drop_dm_object_name("DLP")` \
    | rename object as file, object_path as directory \
    | lookup asset_lookup_by_str asset as dest \
    | lookup asset_lookup_by_str asset as src \
    | lookup asset_lookup_by_str asset as dvc \
    | search category="*ot*" ]


[Threat - OT Sec - Commonly Used Port - Rule]
action.correlationsearch.enabled = 1
action.correlationsearch.label = OT Sec - Commonly Used Port
action.customsearchbuilder.enabled = false
action.customsearchbuilder.spec = {}
action.notable = 1
action.notable.param.rule_description = Commonly Used Port activity Detected on $src$ from $dest$- MITRE ICS SECURITY - T885
action.notable.param.rule_title = OT Sec - Commonly Used Port
action.notable.param.security_domain = OT
action.notable.param.severity = high
action.notable.param.verbose = 0
action.risk = 1
action.risk.param._risk_object = dest
action.risk.param._risk_object_type = system
action.risk.param._risk_score = 100
action.risk.param.verbose = 0
alert.suppress = 1
alert.suppress.fields = dest
alert.suppress.period = 3600s
alert.track = 1
counttype = number of events
cron_schedule = 0 * * * *
description = OT Sec - Commonly Used Port
disabled = 1
dispatch.earliest_time = -60m@m
dispatch.latest_time = -0m@m
dispatch.rt_backfill = 1
enableSched = 1
quantity = 0
realtime_schedule = 0
relation = greater than
request.ui_dispatch_app = SplunkEnterpriseSecuritySuite
search = eventtype=mitre_ics_event technique_id=T885 \
| `get_mitre_host_info_mac` \
| append \
    [| tstats count from datamodel="Network_Traffic.All_Traffic" where All_Traffic.action="allow*" by _time,All_Traffic.src,All_Traffic.dest,All_Traffic.dvc,All_Traffic.dest_port \
    | `drop_dm_object_name("All_Traffic")` \
    | lookup asset_lookup_by_str asset as dest \
    | lookup asset_lookup_by_str asset as src \
    | lookup asset_lookup_by_str asset as dvc OUTPUTNEW asset_type as dvc_asset_type \
    | search category="*ot*" dvc_asset_type="firewall" \
    | lookup interesting_ot_ports src,dest,dest_port OUTPUTNEW app,is_prohibited \
    | search app=* is_prohibited="true" ]\


[Threat - OT Sec - Standard Application Layer Protocol - Rule]
action.correlationsearch.enabled = 1
action.correlationsearch.label = OT Sec - Standard Application Layer Protocol
action.customsearchbuilder.enabled = false
action.customsearchbuilder.spec = {}
action.notable = 1
action.notable.param.rule_description = OT assets attempted to communicate to external host via Standard Application Protocol - MITRE ICS SECURITY - T869
action.notable.param.rule_title = OT Sec - Standard Application Layer Protocol
action.notable.param.security_domain = 
action.notable.param.severity = high
action.notable.param.verbose = 0
action.risk = 1
action.risk.param._risk_object = src
action.risk.param._risk_object_type = system
action.risk.param._risk_score = 100
action.risk.param.verbose = 0
alert.suppress = 1
alert.suppress.fields = src
alert.suppress.period = 3600s
alert.track = 1
counttype = number of events
cron_schedule = 0 * * * *
description = Adversaries may establish command and control capabilities over commonly used application layer protocols such as HTTP(S), OPC, RDP, telnet, DNP3, and modbus. These protocols may be used to disguise adversary actions as benign network traffic. Standard protocols may be seen on their associated port or in some cases over a non-standard port.
disabled = 1
dispatch.earliest_time = -60m@m
dispatch.latest_time = -0m@m
dispatch.rt_backfill = 1
enableSched = 1
quantity = 0
realtime_schedule = 0
relation = greater than
request.ui_dispatch_app = SplunkEnterpriseSecuritySuite
search = eventtype=mitre_ics_event technique_id=T869 \
| `get_mitre_host_info_mac` \
| append \
    [ search index=notable ( search_name="*Detect Large Outbound ICMP Packets*"\
        OR search_name="*Sources Sending a High Volume of DNS Traffic*"\
        OR search_name="*Web Browsing to Unauthorized Sites*"\
        OR search_name="*Sources Sending Many DNS Requests*"\
        OR search_name="*Basic TOR Traffic Detection*"\
        OR search_name="*Basic Dynamic DNS Detection*"\
        OR search_name="*Connection to New Domain*"\
        OR search_name="*Excessive DNS Queries*"\
        OR search_name="*Unusual Web Browser*"\
        OR search_name="*Unusual Geolocation of Communication Destination*"\
        OR search_name="*Blacklisted IP Address*"\
        OR search_name="*Blacklisted Domain*"\
        OR search_name="*Threat Activity Detected*"\
        OR search_name="*Suspicious Domain Communication*"\
        OR search_name="*Suspicious Domain Name*"\
        OR search_name="*Suspicious IP Address Communication*"\
        OR search_name="*Machine Generated Beacon*" ) \
    | lookup asset_lookup_by_str asset as dest \
    | lookup asset_lookup_by_str asset as src \
    | lookup asset_lookup_by_str asset as dvc \
    | search category="*ot*" ]


[Threat - OT Sec - Project File Infection - Rule]
action.correlationsearch.enabled = 1
action.correlationsearch.label = OT Sec - Project File Infection
action.customsearchbuilder.enabled = false
action.customsearchbuilder.spec = {}
action.notable = 1
action.notable.param.rule_description = Potential Project File Infection detected at the endpoint - MITRE ICS SECURITY -T873
action.notable.param.rule_title = OT Sec - Project File Infection
action.notable.param.security_domain = OT
action.notable.param.severity = high
action.notable.param.verbose = 0
action.risk = 1
action.risk.param._risk_object = dest
action.risk.param._risk_object_type = system
action.risk.param._risk_score = 10
action.risk.param.verbose = 0
alert.suppress = 1
alert.suppress.fields = dest
alert.suppress.period = 3600s
alert.track = 1
counttype = number of events
cron_schedule = 0 * * * *
description = OT Sec - Project File Infection
disabled = 1
dispatch.earliest_time = -60m@m
dispatch.latest_time = -0m@m
dispatch.rt_backfill = 1
enableSched = 1
quantity = 0
realtime_schedule = 0
relation = greater than
request.ui_dispatch_app = SplunkEnterpriseSecuritySuite
search = eventtype=mitre_ics_event technique_id=T873 \
| `get_mitre_host_info_mac` \
| append \
    [| tstats summariesonly=false allow_old_summaries=true count min(_time) as firstTime max(_time) as lastTime values(Filesystem.user) as user values(Filesystem.dest) as dest, values(Filesystem.file_path) as file_path from datamodel=Endpoint.Filesystem by Filesystem.file_name \
    | `drop_dm_object_name(Filesystem)` \
    | rex field=file_name "(?<file_extension>\.[^\.]+)$" \
    | search file_extension=.MPP OR file_extension=.mpp OR file_extension=.project \
    | lookup ot_asset_lookup ip as dvc \
    | lookup ot_asset_lookup ip as src \
    | lookup ot_asset_lookup ip as dest \
    | search category="*ot*"] \
| append \
    [ search index="notable" search_name="Prohibited Process Detected" OR “search_name="Basic Malware Outbreak" \
    | lookup ot_asset_lookup ip as dvc \
    | lookup ot_asset_lookup ip as src \
    | lookup ot_asset_lookup ip as dest \
    | search category="*ot*"]

[Threat - OT Sec - Default Credentials - Rule]
action.correlationsearch.enabled = 1
action.correlationsearch.label = OT Sec - Default Credentials
action.customsearchbuilder.enabled = false
action.customsearchbuilder.spec = {}
action.notable = 1
action.notable.param.rule_description = Default credentials activity detected on OT assets - MITRE ICS SECURITY - T812
action.notable.param.rule_title = OT Sec - Default Credentials
action.notable.param.security_domain = OT
action.notable.param.severity = high
action.notable.param.verbose = 0
action.risk = 1
action.risk.param._risk_object = dest
action.risk.param._risk_object_type = system
action.risk.param._risk_score = 10
action.risk.param.verbose = 0
alert.suppress = 1
alert.suppress.fields = src
alert.suppress.period = 3600s
alert.track = 1
counttype = number of events
cron_schedule = 0 * * * *
description = Adversaries may leverage manufacturer or supplier set default credentials on control system devices. These default credentials may have administrative permissions and may be necessary for initial configuration of the device.
disabled = 1
dispatch.earliest_time = -60m@m
dispatch.latest_time = -0m@m
dispatch.rt_backfill = 1
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = SplunkEnterpriseSecuritySuite
search = eventtype=mitre_ics_event technique_id=T812\
| `get_mitre_host_info_mac` \
| append \
    [| tstats `summariesonly` max(_time) as _time,values(Authentication.user_category) as user_category from datamodel=Authentication.Authentication where Authentication.user_category=default by Authentication.dest Authentication.user, Authentication.src\
    | `drop_dm_object_name("Authentication")` \
    | search user_category=default\
    |  lookup scada_passes username as user\
    | lookup asset_lookup_by_str asset as src\
    | eval vendor=upper(Vendor), asset_vendor=upper(asset_vendor)\
    | where vendor=asset_vendor\
    | search category="*ot*" Device=* ]

[OT Assets - OEE]
action.keyindicator = 1
action.keyindicator.delta = OEE
action.keyindicator.subtitle = Operational Health KPI
action.keyindicator.title = Operational OEE
action.keyindicator.value = OEE
action.keyindicator.value_suffix = %
enableSched = false
search = index=_internal\
| head 5\
| eval high = 85\
| eval low = 78\
| eval OEE = round(((random() % high)/(high)) * (high - low) + low)\
| table _time, OEE

[ot_sec_tot_risk_score]
action.keyindicator = 1
action.keyindicator.delta = risk_score
action.keyindicator.subtitle = ot_sec_tot_risk_score
action.keyindicator.title = ot_sec_tot_risk_score
action.keyindicator.value = risk_score
search = index=risk \
| eval _time=strftime(_time,"%Y-%m-%d")\
| stats sum(risk_score) as risk_score by _time, risk_object, risk_object_type\
| lookup ot_asset_lookup ip as risk_object \
| lookup cip_asset_lookup ip as risk_object \
| search asset_type=*\
| stats sum(risk_score) as risk_score by _time

[OT Vulnerability - New CVEs]
action.keyindicator = 1
action.keyindicator.delta = count
action.keyindicator.group.0.name = ot_asset_center
action.keyindicator.group.0.order = 3
action.keyindicator.group.1.name = ot_asset_bulletin_updates
action.keyindicator.group.1.order = 0
action.keyindicator.group.2.name = OT_Asset_Vulnerability_Updates
action.keyindicator.group.2.order = 2
action.keyindicator.subtitle = Newly CVEs published today
action.keyindicator.title = OT Asset - Vulnerability - New CVEs
action.keyindicator.value = count
enableSched = false
search = index=cve publishedDate="2020*"\
| rex field=publishedDate "(?P<evt_date>\d{4}-\d{2}-\d{2})"\
| eval time_evt=strptime(publishedDate, "%Y-%m-%d")\
| eval _time=time_evt\
| eval time_now=now()\
| eval time_diff=time_now-time_evt\
| search time_diff<2592000\
| table _time cve time*\
| timechart count span=1d

[evt_sum_ot_asset_traffic_snap_1d]
action.email.useNSSubject = 1
action.keyindicator.invert = 0
action.makestreams.param.verbose = 0
action.nbtstat.param.verbose = 0
action.notable.param.verbose = 0
action.nslookup.param.verbose = 0
action.ping.param.verbose = 0
action.risk.param.verbose = 0
action.send2uba.param.verbose = 0
action.summary_index._name = evt_sum_ot_asset_traffic
action.summary_index.sum_type = evt_sum_ot_asset_traffic_1d
action.threat_add.param.verbose = 0
alert.track = 0
cron_schedule = 10 0 * * *
dispatch.earliest_time = -1d@d
dispatch.latest_time = -0d@d
display.events.fields = ["host","source","sourcetype","lastModifiedDate","cve","cve_prod","description","product_name","vendor_product","ref_url","name","asset_id","asset_model","asset_status","asset_type","asset_type","asset_type","asset_type","asset_type","asset_type","asset_type ","asset_vendor","asset_version","classification","location","exposure","nt_host","ip","zone","priority"]
display.general.type = statistics
display.page.search.mode = verbose
display.page.search.tab = statistics
display.visualizations.charting.chart = bar
display.visualizations.show = 0
enableSched = 1
realtime_schedule = 0
request.ui_dispatch_app = DA-ESS-OTSecurity
request.ui_dispatch_view = search
search = index=evt_sum_ot_asset_traffic ( dest_asset_type="*" or src_asset_type="*" or dvc_asset_type=* ) sum_type=evt_sum_ot_asset_traffic_1d \
| stats sum(tot_bytes) as tot_bytes, sum(tot_port_com_num) as tot_port_com_num, sum(tot_session) as tot_session, sum(tot_duration) as tot_duration by dest \
| append \
    [ search index=evt_sum_ot_asset_traffic src_asset_type="*" sum_type=evt_sum_ot_asset_traffic_1d\
    | stats sum(tot_bytes) as tot_bytes, sum(tot_port_com_num) as tot_port_com_num, sum(tot_session) as tot_session, sum(tot_duration) as tot_duration by src] \
| strcat src dest dvc \
| stats sum(tot_bytes) as tot_bytes, avg(tot_port_com_num) as avg_port_com_num, sum(tot_session) as tot_session, sum(tot_duration) as tot_duration by dvc \
| sort - tot_bytes \
| table dvc tot_bytes avg_port_com_num tot_session tot_duration\
| collect index=evt_sum_ot_asset_traffic marker="sum_type=evt_sum_ot_asset_traffic_snap_1d"

[OT Assets - Total Assets SW]
action.keyindicator = 1
action.keyindicator.group.0.name = ot_asset_center
action.keyindicator.group.0.order = 1
action.keyindicator.group.1.name = ot_asset_status_search
action.keyindicator.group.1.order = 1
action.keyindicator.group.2.name = ot_asset_center_01
action.keyindicator.group.2.order = 0
action.keyindicator.subtitle = Total SW Assets
action.keyindicator.title = OT Assets - Total Assets SW
action.keyindicator.value = count
cron_schedule = 0 0 * * *
dispatch.earliest_time = -30d@d
enableSched = 1
search = `get_ot_assets_sw`\
| timechart span=7d count

[OT Assets - Critical Assets /w Vulnerability]
action.keyindicator = 1
action.keyindicator.subtitle = Total number of current critical assets with CVE vulnerability
action.keyindicator.title = OT Assets - Critical Assets /w Vulnerability
action.keyindicator.value = count
action.keyindicator.drilldown_uri =
action.keyindicator.group.0.name = ot_asset_center_02
action.keyindicator.group.0.order = 2
alert.track = 0
cron_schedule = 0 */24 * * *
dispatch.earliest_time = -30d@d
enableSched = 1
search = `get_ot_assets_sw`\
| search priority=critical\
| timechart span=7d count

[sum_evt_cve_joined_1d]
action.email.useNSSubject = 1
action.keyindicator.invert = 0
action.makestreams.param.verbose = 0
action.nbtstat.param.verbose = 0
action.notable.param.verbose = 0
action.nslookup.param.verbose = 0
action.ping.param.verbose = 0
action.risk.param.verbose = 0
action.send2uba.param.verbose = 0
action.threat_add.param.verbose = 0
alert.track = 0
cron_schedule = 10 0 * * *
dispatch.earliest_time = -1d@d
dispatch.latest_time = -0d@d
display.events.fields = ["host","source","sourcetype","dest_asset","dest_asset_id","dest_asset_model","dest_asset_status","dest_asset_system","dest_asset_tag","dest_asset_type","dest_asset_vendor","dvc_asset","dvc_asset_id","dvc_asset_model","dvc_asset_status","dvc_asset_system","dvc_asset_tag","dvc_asset_type","dvc_asset_vendor","src_asset","src_asset_id","src_asset_model","src_asset_status","src_asset_system","src_asset_tag","src_asset_type","src_asset_vendor","src","dvc_nt_host"]
display.events.type = raw
display.general.type = statistics
display.page.search.mode = verbose
display.page.search.tab = statistics
display.visualizations.chartHeight = 420
display.visualizations.charting.chart = line
display.visualizations.custom.type = network-diagram-viz.network-diagram-viz
display.visualizations.show = 0
enableSched = 1
request.ui_dispatch_app = SplunkEnterpriseSecuritySuite
request.ui_dispatch_view = search
search = `get_latest_vuln(1)`\
| collect index="cve_sum" marker="sum_type=cve_joined_1d"

[evt_sum_ot_asset_traffic_1d]
action.email.useNSSubject = 1
action.keyindicator.invert = 0
action.makestreams.param.verbose = 0
action.nbtstat.param.verbose = 0
action.notable.param.verbose = 0
action.nslookup.param.verbose = 0
action.ping.param.verbose = 0
action.risk.param.verbose = 0
action.send2uba.param.verbose = 0
action.summary_index._name = evt_sum_ot_asset_traffic
action.summary_index.sum_type = evt_sum_ot_asset_traffic_1d
action.threat_add.param.verbose = 0
alert.track = 0
cron_schedule = 5 0 * * *
dispatch.earliest_time = -1d@d
dispatch.latest_time = -0d@d
display.events.fields = ["host","source","sourcetype","lastModifiedDate","cve","cve_prod","description","product_name","vendor_product","ref_url","name","asset_id","asset_model","asset_status","asset_type","asset_type","asset_type","asset_type","asset_type","asset_type","asset_type ","asset_vendor","asset_version","classification","location","exposure","nt_host","ip","zone","priority"]
display.general.type = statistics
display.page.search.mode = verbose
display.page.search.tab = statistics
display.visualizations.charting.chart = bar
display.visualizations.show = 0
enableSched = 1
realtime_schedule = 0
request.ui_dispatch_app = DA-ESS-OTSecurity
request.ui_dispatch_view = search
search = tag=network ( dvc_asset_id=* OR src_asset_id=* OR dest_asset_id=* )\
| stats first(_time) as time_first, last(_time) as time_last, count as tot_session, sum(bytes) as tot_bytes, sum(duration) as tot_duration by src dest  dest_port _time\
| eval dest_port_sum="dest_port="+dest_port+":tot_bytes="+tot_bytes+":duration="+tot_duration\
| eval _time=strftime(_time,"%Y-%m-%d")\
| stats min(time_first) as time_first, max(time_last) as time_last, sum(tot_session) as tot_session, sum(tot_bytes) as tot_bytes, sum(tot_duration) as tot_duration, values(dest_port_sum) as dest_port_sum, dc(dest_port_sum) as tot_port_com_num by _time src dest\
| collect index="evt_sum_ot_asset_traffic" marker="sum_type=evt_sum_ot_asset_traffic_1d"

[Ot_asset - OT Sec - Network Sniffing - Rule]
action.correlationsearch.enabled = 1
action.correlationsearch.label = OT Sec - Network Sniffing
action.customsearchbuilder.enabled = false
action.customsearchbuilder.spec = {}
action.notable = 1
action.notable.param.rule_description = Insecure Network Sniffing activities detected - MITRE ICS SECURITY - T842
action.notable.param.rule_title = OT Sec - Network Sniffing
action.notable.param.security_domain = OT
action.notable.param.severity = high
action.notable.param.verbose = 0
alert.suppress = 1
alert.suppress.fields = dvc
alert.suppress.period = 3600s
alert.track = 1
counttype = number of events
cron_schedule = 0 * * * *
description = OT Sec - Network Sniffing - T842
disabled = 1
dispatch.earliest_time = -60m@m
dispatch.latest_time = -0m@m
dispatch.rt_backfill = 1
enableSched = 1
quantity = 0
realtime_schedule = 0
relation = greater than
request.ui_dispatch_app = SplunkEnterpriseSecuritySuite
search = eventtype=mitre_ics_event technique_id=T842 \
| `get_mitre_host_info_mac` \
| append \
    [ search index=notable ( search_name="*Access - Insecure Or Cleartext Authentication*" \
        OR search_name="*Protocols passing authentication in cleartext*") \
    | lookup ot_asset_lookup ip as dest \
    | lookup ot_asset_lookup ip as src \
    | lookup ot_asset_lookup ip as dvc \
    | fillnull dest_category, src_category, dvc_category value="NA" \
    | search dest_category="*ot*" OR src_category="*ot*" OR dvc_category="*ot*" ]


[Threat - OT Sec - Data Historian Compromise - Rule]
action.correlationsearch.enabled = 1
action.correlationsearch.label = OT Sec - Data Historian Compromise
action.customsearchbuilder.enabled = false
action.customsearchbuilder.spec = {}
action.notable = 1
action.notable.param.rule_description = Potential "Data Historian Compromise" due to detected malware at this endpoint that matches historian asset. MITRE ICS SECURITY - T810
action.notable.param.rule_title = OT Sec - Data Historian Compromise
action.notable.param.security_domain = OT
action.notable.param.severity = critical
action.notable.param.verbose = 0
action.risk = 1
action.risk.param._risk_object = dest
action.risk.param._risk_object_type = system
action.risk.param._risk_score = 10
alert.suppress = 1
alert.suppress.fields = dvc
alert.suppress.period = 3600s
alert.track = 1
counttype = number of events
cron_schedule = 0 * * * *
description = Adversaries may compromise and gain control of a data historian to gain a foothold into the control system environment. Access to a data historian may be used to learn stored database archival and analysis information on the control system. A dual-homed data historian may provide adversaries an interface from the IT environment to the OT environment.  MITRE ICS SECURITY - T810
dispatch.earliest_time = -60m@m
dispatch.latest_time = -0m@m
dispatch.rt_backfill = 1
enableSched = 1
quantity = 0
realtime_schedule = 0
relation = greater than
request.ui_dispatch_app = DA-ESS-OTSecurity
schedule_window = auto
search = eventtype=mitre_ics_event technique_id=T810 \
| `get_mitre_host_info_mac` \
| append \
    [ search index="notable" ( search_name="Endpoint - High Or Critical Priority Host With Malware Detected" OR search_name="Prohibited Software On Endpoint" OR search_name="Host With A Recurring Malware Infection" OR search_name="High Or Critical Priority Host With Malware Detected" OR search_name="High Number of Hosts Not Updating Malware Signatures" OR search_name="Host With Old Infection Or Potential Re-Infection" OR search_name=" Prohibited Software On Endpoint" OR search_name=" Host With A Recurring Malware Infection" OR search_name=" High Or Critical Priority Host With Malware Detected" OR search_name=" Host With Old Infection Or Potential Re-Infection" OR search_name=" Basic Malware Outbreak (SSE)" OR search_name=" Endpoint Uncleaned Malware Detection (SSE)" OR search_name=" Multiple Infections on Host (SSE)" OR search_name=" New Local Admin Account (SSE)" OR search_name=" Recurring Infection on Host (SSE)" OR search_name=" User Login with Local Credentials (SSE)" OR search_name=" Disabled Update Service (SSE)" OR search_name=" Hosts Sending To More Destinations Than Normal (SSE)" OR search_name="*Host With Multiple Infections*" OR search_name=" Outbreak Detected (ES)" OR search_name=" Anomalous Audit Trail Activity Detected (ES)" OR search_name=" Default Account Activity Detected (ES)" OR search_name=" Same Error On Many Servers Detected (ES)" OR search_name=" Substantial Increase In Events (ES)" OR search_name=" Suspicious HTTP Redirects" ) \
    | search dest_asset_type=historian OR src_asset_type=historian \
    | eval dvc=dvc_tmp \
    | strcat src dest dvc_tmp dvc \
    | stats last(infection_count) as infection_count, values(asset_criticality) as asset_criticality, values(asset_type) as asset_type, values(category) as category, values(nt_host) as nt_host, values(location) as location, values(vendor_product) as vendor_product, values(hw_model) as hw_model, values(hw_join) as hw_join, count, latest(_raw) as "orig_raw" by dvc]

[OT Asset - Vulnerability - Published CVEs last 30d]
action.keyindicator = 1
action.keyindicator.delta = count
action.keyindicator.group.0.name = ot_asset_center
action.keyindicator.group.0.order = 2
action.keyindicator.group.1.name = 
action.keyindicator.group.1.order = 0 
action.keyindicator.group.2.name = ot_asset_center_02
action.keyindicator.group.2.order = 0
action.keyindicator.group.3.name = OT_Asset_Vulnerability_Updates
action.keyindicator.group.3.order = 0
action.keyindicator.subtitle = Latest published CVEs within 30 days
action.keyindicator.title = OT Asset - Vulnerability - Published CVEs last 30d
action.keyindicator.value = count
cron_schedule = 0 0 * * *
dispatch.earliest_time = -24h@h
enableSched = 1
search = index=cve publishedDate="2020*" OR publishedDate="2021*" OR publishedDate="2022*"\
| rex field=publishedDate "(?P<evt_date>\d{4}-\d{2}-\d{2})"\
| eval time_evt=strptime(publishedDate, "%Y-%m-%d")\
| eval _time=time_evt\
| eval time_now=now()\
| eval time_diff=time_now-time_evt\
| search time_diff<2592000\
| table _time cve time*\
| stats count

[OT Assets - Vulnerability - Latest CVE]
action.keyindicator = 1
action.keyindicator.group.0.name = OT_Asset_Vulnerability_Updates
action.keyindicator.group.0.order = 1
action.keyindicator.subtitle = Last 24 HR
action.keyindicator.title = Latest CVEs Updated
enableSched = false
search = index=cve_sum sum_type=cve_joined_1d earliest=-24h@h latest=+0h@h \
| eval date_epoch_now=now() \
| convert timeformat="%Y-%m-%dT%H:%MZ" mktime(lastModifiedDate) as date_epoch_lastmod \
| eval _time=date_epoch_lastmod \
| eval date_latest_cut_window=date_epoch_now-(86500*3) \
| where _time>date_latest_cut_window \
| search \
| table _time cve vendor product_name version base_score description reference \
| stats count as current_count \
| appendcols \
    [ search index=cve_sum sum_type=cve_joined_1d earliest=-48h@h latest=+24h@h \
    | eval date_epoch_now=now() \
    | convert timeformat="%Y-%m-%dT%H:%MZ" mktime(lastModifiedDate) as date_epoch_lastmod \
    | eval _time=date_epoch_lastmod \
    | eval date_latest_cut_window=date_epoch_now-(86500*3) \
    | where _time>date_latest_cut_window \
    | search \
    | table _time cve vendor product_name version base_score description reference \
    | stats count as historical_count ]\
| `get_ksi_fields(current_count, historical_count)` \
| eval delta=current_count-historical_count\
| table current_count historical_count delta direction

[OT Sec - Total Types of OT Security Alarms]
action.keyindicator = 1
action.keyindicator.delta = count
action.keyindicator.drilldown_uri = 
action.keyindicator.group.0.name = security_posture
action.keyindicator.group.0.order = 4
action.keyindicator.subtitle = Number of different OT Alarms
action.keyindicator.title = OT Sec - Alarms Trends
action.keyindicator.value = count
cron_schedule = */30 * * * *
dispatch.earliest_time = -24h@h
enableSched = true
search = index="notable" search_name="*OT Sec*"\
| timechart count

[OT Assets - Active Notables]
action.keyindicator = 1
action.keyindicator.delta = count
action.keyindicator.drilldown_uri = 
action.keyindicator.group.0.name = OT_Security_Posture
action.keyindicator.group.0.order = 4
action.keyindicator.invert = 0
action.keyindicator.subtitle = Count of Active Asset Notables
action.keyindicator.title = Active Asset Notables
action.keyindicator.value = count
action.makestreams.param.verbose = 0
action.nbtstat.param.verbose = 0
action.notable.param.verbose = 0
action.nslookup.param.verbose = 0
action.ping.param.verbose = 0
action.risk.param.verbose = 0
action.send2uba.param.verbose = 0
action.threat_add.param.verbose = 0
alert.track = 0
display.general.type = visualizations
display.page.search.tab = visualizations
enableSched = 1
cron_schedule = 0 * * * *
dispatch.earliest_time = -24h@h
search = index=notable (dvc_category="*ot*" OR src_category="*ot*" OR dest_category="*ot*")\
| strcat src dest dvc asset\
| timechart dc(search_name) as count

[OT Assets - Risk - Aggregated Risk]
action.keyindicator = 1
action.keyindicator.drilldown_uri = 
action.keyindicator.group.0.name = OT_Security_Posture
action.keyindicator.group.0.order = 0
action.keyindicator.group.1.name = 
action.keyindicator.group.1.order = 

action.keyindicator.subtitle = Sum of Total Risk - Last 24 hr
action.keyindicator.title = Overall Asset Risk Score
cron_schedule = 0 * * * *
dispatch.earliest_time = -24h
enableSched = true
search = index=risk earliest=-24h@h latest=+0s \
| eval _time=strftime(_time,"%Y-%m-%d")\
| stats sum(risk_score) as risk_score by _time, risk_object, risk_object_type\
| lookup ot_asset_lookup ip as risk_object \
| lookup cip_asset_lookup ip as risk_object \
| search asset_type=*\
| stats sum(risk_score) as current_count\
| appendcols \
    [ search index=risk earliest=-48h@h latest=-24h@h \
| eval _time=strftime(_time,"%Y-%m-%d")\
| stats sum(risk_score) as risk_score by _time, risk_object, risk_object_type\
| lookup ot_asset_lookup ip as risk_object \
| lookup cip_asset_lookup ip as risk_object \
| search asset_type=*\
| stats sum(risk_score) as historical_count ]\
| `get_ksi_fields(current_count, historical_count)` \
| `get_percentage_qualitative(delta, delta_qual)`

[OT Assets - Active OP Panels]
action.keyindicator = 1
action.keyindicator.delta = count
action.keyindicator.group.0.name = ot_asset_status_search
action.keyindicator.group.0.order = 4
action.keyindicator.subtitle = OT Assets - Total Active OP Panels
action.keyindicator.title = OT Assets - OP Panels
action.keyindicator.value = count
action.keyindicator.invert = 0
action.makestreams.param.verbose = 0
action.nbtstat.param.verbose = 0
action.notable.param.verbose = 0
action.nslookup.param.verbose = 0
action.ping.param.verbose = 0
action.risk.param.verbose = 0
action.send2uba.param.verbose = 0
action.threat_add.param.verbose = 0
alert.track = 0
cron_schedule = 0 0 * * *
dispatch.earliest_time = -24h@h
enableSched = 1
search = |  `get_ot_assets_hw`\
| search asset_type=*operator panel*\
| stats count

[OT Assets - Active Actuators]
action.keyindicator = 1
action.keyindicator.delta = count
action.keyindicator.group.0.name = 
action.keyindicator.group.0.order = 
action.keyindicator.subtitle = OT Assets - Total Active Actuators
action.keyindicator.title = OT Assets - Actuators
action.keyindicator.value = count
action.keyindicator.invert = 0
action.makestreams.param.verbose = 0
action.nbtstat.param.verbose = 0
action.notable.param.verbose = 0
action.nslookup.param.verbose = 0
action.ping.param.verbose = 0
action.risk.param.verbose = 0
action.send2uba.param.verbose = 0
action.threat_add.param.verbose = 0
alert.track = 0
cron_schedule = 0 0 * * *
dispatch.earliest_time = -24h@h
display.general.type = statistics
display.page.search.tab = statistics
request.ui_dispatch_view = search
enableSched = 1
search = | `get_ot_assets_hw`\
| search asset_type=actuator\
| stats count

[OT Assets - Active RTUs]
action.keyindicator = 1
action.keyindicator.delta = count
action.keyindicator.group.0.name = ot_asset_status_search
action.keyindicator.group.0.order = 3
action.keyindicator.group.1.name = 
action.keyindicator.group.1.order = 
action.keyindicator.subtitle = OT Assets - Total Active RTUs
action.keyindicator.title = OT Assets - RTUs
action.keyindicator.value = count
action.keyindicator.invert = 0
action.makestreams.param.verbose = 0
action.nbtstat.param.verbose = 0
action.notable.param.verbose = 0
action.nslookup.param.verbose = 0
action.ping.param.verbose = 0
action.risk.param.verbose = 0
action.send2uba.param.verbose = 0
action.threat_add.param.verbose = 0
alert.track = 0
cron_schedule = 0 0 * * *
dispatch.earliest_time = -24h@h
enableSched = 1
search = | `get_ot_assets_hw`\
| search asset_type=rtu\
| stats count

[OT Assets - Active PLCs]
action.keyindicator = 1
action.keyindicator.delta = count
action.keyindicator.group.0.name = 
action.keyindicator.group.0.order = 
action.keyindicator.group.1.name = ot_asset_center_01
action.keyindicator.group.1.order = 1
action.keyindicator.subtitle = OT Assets - Total Active PLCs
action.keyindicator.title = OT Assets - PLCs
action.keyindicator.value = count
action.keyindicator.invert = 0
action.makestreams.param.verbose = 0
action.nbtstat.param.verbose = 0
action.notable.param.verbose = 0
action.nslookup.param.verbose = 0
action.ping.param.verbose = 0
action.risk.param.verbose = 0
action.send2uba.param.verbose = 0
action.threat_add.param.verbose = 0
alert.track = 0
cron_schedule = 0 0 * * *
dispatch.earliest_time = -24h@h
enableSched = 1
search = |  `get_ot_assets_hw`\
| search asset_type=plc\
| stats count

[OT Assets - Risk - Avg Score]
action.keyindicator = 1
action.keyindicator.drilldown_uri = 
action.keyindicator.group.0.name = OT_Security_Posture
action.keyindicator.group.0.order = 2
action.keyindicator.group.1.name = ot_asset_center_02
action.keyindicator.group.1.order = 1
action.keyindicator.subtitle = Average of Risk Score per Asset - Last 24 hr
action.keyindicator.title = Per Asset Risk Score
enableSched = false
search = index=risk earliest=-24h@h latest=+0s \
| eval _time=strftime(_time,"%Y-%m-%d")\
| stats sum(risk_score) as risk_score by _time, risk_object, risk_object_type\
| lookup ot_asset_lookup ip as risk_object \
| lookup cip_asset_lookup ip as risk_object \
| search asset_type=*\
| stats avg(risk_score) as current_count\
| appendcols \
    [ search index=risk earliest=-48h@h latest=-24h@h \
| eval _time=strftime(_time,"%Y-%m-%d")\
| stats sum(risk_score) as risk_score by _time, risk_object, risk_object_type\
| lookup ot_asset_lookup ip as risk_object \
| lookup cip_asset_lookup ip as risk_object \
| search asset_type=*\
| stats avg(risk_score) as historical_count ]\
| `get_ksi_fields(current_count, historical_count)` \
| eval delta=current_count-historical_count\
| table current_count historical_count delta direction

[OT Assets - Risk - Host Count]
action.keyindicator = 1
action.keyindicator.drilldown_uri = 
action.keyindicator.group.0.name = OT_Security_Posture
action.keyindicator.group.0.order = 1
action.keyindicator.subtitle = Count of assets with risk - Last 24 hr
action.keyindicator.title = Number of Assets with Risk
enableSched = false
search = index=risk earliest=-24h@h latest=+0s \
| eval _time=strftime(_time,"%Y-%m-%d")\
| stats sum(risk_score) as risk_score by _time, risk_object, risk_object_type\
| lookup ot_asset_lookup ip as risk_object \
| lookup cip_asset_lookup ip as risk_object \
| search asset_type=*\
| stats count as current_count\
| appendcols \
    [ search index=risk earliest=-48h@h latest=-24h@h \
| eval _time=strftime(_time,"%Y-%m-%d")\
| stats sum(risk_score) as risk_score by _time, risk_object, risk_object_type\
| lookup ot_asset_lookup ip as risk_object \
| lookup cip_asset_lookup ip as risk_object \
| search asset_type=*\
| stats count as historical_count ]\
| `get_ksi_fields(current_count, historical_count)` \
| eval delta=current_count-historical_count\
| table current_count historical_count delta direction

[OT Assets - Total Assets]
action.keyindicator = 1
action.keyindicator.drilldown_uri = 
action.keyindicator.group.0.name = ot_asset_center
action.keyindicator.group.0.order = 0
action.keyindicator.group.1.name = security_posture
action.keyindicator.group.1.order = 3
action.keyindicator.group.2.name = ot_asset_status_search
action.keyindicator.group.2.order = 0
action.keyindicator.group.3.name = OT_Security_Posture
action.keyindicator.group.3.order = 3
action.keyindicator.group.4.name = ot_asset_center_01
action.keyindicator.group.4.order = 2
action.keyindicator.subtitle = Total number of assets
action.keyindicator.title = Number of Assets
action.keyindicator.value = count
action.keyindicator.invert = 0
alert.track = 0
cron_schedule = 0 */24 * * *
dispatch.earliest_time = -24h@h
action.makestreams.param.verbose = 0
action.nbtstat.param.verbose = 0
action.notable.param.verbose = 0
action.nslookup.param.verbose = 0
action.ping.param.verbose = 0
action.risk.param.verbose = 0
action.send2uba.param.verbose = 0
action.threat_add.param.verbose = 0
enableSched = 1
search = | `get_ot_assets_hw`\
| stats count

[OT Assets - Asset Count with Notables]
action.keyindicator = 1
action.keyindicator.delta = count
action.keyindicator.drilldown_uri = 
action.keyindicator.group.0.name = OT_Security_Posture
action.keyindicator.group.0.order = 5
action.keyindicator.group.1.name = ot_asset_center_01
action.keyindicator.group.1.order = 1
action.keyindicator.subtitle = Count of Assets with Active Notables
action.keyindicator.title = Assets with Notables
action.keyindicator.value = count
action.keyindicator.invert = 0
action.makestreams.param.verbose = 0
action.nbtstat.param.verbose = 0
action.notable.param.verbose = 0
action.nslookup.param.verbose = 0
action.ping.param.verbose = 0
action.risk.param.verbose = 0
action.send2uba.param.verbose = 0
action.threat_add.param.verbose = 0
alert.track = 0
cron_schedule = */30 * * * *
dispatch.earliest_time = -30d@d
display.general.type = statistics
display.page.search.tab = statistics
enableSched = 1
search = index=notable (dvc_category="ot*" OR src_category="ot*" OR dest_category="ot*")\
| strcat src dest dvc asset\
| timechart span=12h dc(asset) as count


#### NERC CIP Section
[Threat - Unapproved removal media use on OT Asset - Rule]
action.correlationsearch.enabled = 1
action.correlationsearch.label = Unapproved removal media use on OT Asset
action.customsearchbuilder.enabled = false
action.customsearchbuilder.spec = {}
action.notable = 1
action.notable.param.drilldown_name = View USB Removable Usage
action.notable.param.drilldown_search = `get_usb_datasources` DeviceType="Removable Storage" | rename ComputerName as nt_host, category as device_category | lookup asset_lookup_by_str nt_host OUTPUTNEW priority, category | lookup all_assets nt_host as device OUTPUTNEW classification | fillnull classification value="Unapproved" | search (priority="critical" OR priority="high") (classification!=*cip:tca*) | rename nt_host as dvc
action.notable.param.extract_artifacts = {"asset":["dest","dvc"],"identity":["user"]}
action.risk = 1
action.risk.param._risk_object = user
action.risk.param._risk_object_type = user
action.risk.param._risk_score = 70
action.notable.param.recommended_actions = email,logevent,risk
action.notable.param.rule_description = A host ($dest$) was detected using removable media on an OT host with $priority$ priority.  Removal Media Device labeled $device$
action.notable.param.rule_title = Unapproved removable media on OT asset ($dest$)
action.notable.param.security_domain = OT
action.notable.param.severity = high
action.notable.param.verbose = 0
alert.suppress = 1
alert.suppress.fields = device,dvc
alert.suppress.period = 60s
alert.track = 1
counttype = number of events
cron_schedule = */5 * * * *
description = Alerting on removable media on a machine that is classified as high or critical using an unapproved removable media device
dispatch.earliest_time = -10m
dispatch.latest_time = now
dispatch.rt_backfill = 1
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = DA-ESS-OTSecurity
search = `get_usb_datasources`  DeviceType="Removable Storage"\
| rename ComputerName as nt_host, category as device_category\
| lookup cip_asset_lookup nt_host OUTPUTNEW priority, category\
| lookup cip_asset_lookup nt_host as device OUTPUTNEW classification\
| fillnull classification value="Unapproved"\
| search (priority="critical" OR priority="high") (classification!=*cip:tca*)\
| rename nt_host as dvc

[OT - Access granted for uncertified individual - Rule]
action.correlationsearch.enabled = 1
action.correlationsearch.label = Access granted for uncertified individual
action.customsearchbuilder.enabled = false
action.customsearchbuilder.spec = {}
action.notable = 1
action.notable.param.drilldown_name = View of logins by $user$
action.notable.param.drilldown_search = | pivot Authentication Successful_Authentication count(Successful_Authentication) AS "Count of Successful Authentication" SPLITROW _time AS _time PERIOD auto SPLITROW src AS src SPLITROW user SPLITROW dest SPLITROW app  | search     [| inputlookup cip_asset_lookup     | eval Authentdest=nt_host      | fields dest ]  | join type=left user      [| `get_cip_training_and_members`      | search State="REQUIRED" members="*" distribution_list_name="*"      | join type=left members,title          [| inputlookup cip_training_records.csv          | eval members=user          | fields members,score,completed_date,title,next_certification_date ]      | eval next_three_months=relative_time(now(), "+3mon@day"), next_certification_epoch=strptime(next_certification_date, "%m/%d/%Y"), today_now=now()      | eval cert_state=if(next_certification_epoch <= next_three_months, if(today_now >= next_certification_epoch, "Expired", "Approaching Renewal"), "Good")     | rex field=members "(?<user>[^@]+)"     | search cert_state="Expired"      | fields user,cert_state,distribution_list_name ]  | search cert_state="Expired" action=success | stats count as event_count values(src) as sources values(dest) as destinations by user
action.notable.param.extract_artifacts = {"asset":["src","dest","dvc","orig_host","sources"],"identity":["src_user","user","src_user_id","src_user_role","user_id","user_role","vendor_account"]}
action.notable.param.recommended_actions = email
action.notable.param.rule_description = $user$ is currently showing an expired certification and has accessed
action.notable.param.rule_title = Access granted for uncertified user - $user$
action.notable.param.security_domain = OT
action.notable.param.severity = medium
action.notable.param.verbose = 0
action.risk = 1
action.risk.param._risk_object = user
action.risk.param._risk_object_type = user
action.risk.param._risk_score = 40
action.risk.param.verbose = 0
alert.suppress = 1
alert.suppress.fields = user
alert.suppress.period = 3600s
alert.track = 1
counttype = number of events
cron_schedule = */60 * * * *
description = Several regulation frameworks such as NERC CIP require individuals to be certified before cyber systems.  This alert is designed to notify when uncertified systems access cyber systems and does not include failed login attempts.
dispatch.earliest_time = -60m
dispatch.latest_time = now
dispatch.rt_backfill = 1
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = SplunkEnterpriseSecuritySuite
schedule_window = auto
search = | tstats count from datamodel=Authentication WHERE Authentication.action="success" by _time,Authentication.src,Authentication.user,Authentication.app,Authentication.dest \
| `drop_dm_object_name("Authentication")` \
| search     [| inputlookup cip_asset_lookup\
    | eval Authentdest=nt_host \
    | fields dest ] \
| join type=left user \
    [| `get_cip_training_and_members` \
    | search State="REQUIRED" members="*" distribution_list_name="*" \
    | join type=left members,title \
        [| inputlookup cip_training_records.csv \
        | eval members=user \
        | fields members,score,completed_date,title,next_certification_date ] \
    | eval next_three_months=relative_time(now(), "+3mon@day"), next_certification_epoch=strptime(next_certification_date, "%m/%d/%Y"), today_now=now() \
    | eval cert_state=if(next_certification_epoch <= next_three_months, if(today_now >= next_certification_epoch, "Expired", "Approaching Renewal"), "Good")\
    | rex field=members "(?<user>[^@]+)"\
    | search cert_state="Expired" \
    | fields user,cert_state,distribution_list_name ] \
| search cert_state="Expired" action=success\
| stats count as event_count values(src) as sources values(dest) as destinations by user

[OT Assets - Active OT Devices]
action.keyindicator = 1
action.keyindicator.delta = count
action.keyindicator.group.0.name = ot_asset_status_search
action.keyindicator.group.0.order = 2
action.keyindicator.group.1.name = ot_asset_center_01
action.keyindicator.group.1.order = 4
action.keyindicator.invert = 0
action.keyindicator.subtitle = Total Active OT Devices
action.keyindicator.title = OT Assets - Active OT Devices
action.keyindicator.value = count
action.makestreams.param.verbose = 0
action.nbtstat.param.verbose = 0
action.notable.param.verbose = 0
action.nslookup.param.verbose = 0
action.ping.param.verbose = 0
action.risk.param.verbose = 0
action.send2uba.param.verbose = 0
action.threat_add.param.verbose = 0
alert.track = 0
cron_schedule = 0 0 * * *
dispatch.earliest_time = -60m
dispatch.latest_time = now
display.general.type = statistics
display.page.search.tab = statistics
enableSched = 1
request.ui_dispatch_view = search
search = `get_ot_assets_hw`\
| search `get_ot_device_asset_types(asset_type)`\
| stats count

[OT Assets - Active IT/OT Devices]
action.keyindicator = 1
action.keyindicator.delta = count
action.keyindicator.group.0.name = ot_asset_status_search
action.keyindicator.group.0.order = 2
action.keyindicator.group.1.name = ot_asset_center_01
action.keyindicator.group.1.order = 3
action.keyindicator.invert = 0
action.keyindicator.subtitle = Total Active IT/OT Devices
action.keyindicator.title = OT Assets - Active IT/OT Devices
action.keyindicator.value = count
action.makestreams.param.verbose = 0
action.nbtstat.param.verbose = 0
action.notable.param.verbose = 0
action.nslookup.param.verbose = 0
action.ping.param.verbose = 0
action.risk.param.verbose = 0
action.send2uba.param.verbose = 0
action.threat_add.param.verbose = 0
alert.track = 0
cron_schedule = 0 0 * * *
dispatch.earliest_time = -1d@d
display.general.type = statistics
display.page.search.tab = statistics
enableSched = 1
request.ui_dispatch_view = search
search = |  `get_ot_assets_hw`\
| search NOT `get_ot_device_asset_types(asset_type)`\
| stats count

[OT - OT Sec - Denial of Service - Rule]
action.correlationsearch.enabled = 1
action.correlationsearch.label = OT Sec - Denial of Service
action.customsearchbuilder.enabled = false
action.customsearchbuilder.spec = {}
action.notable = 1
action.notable.param.rule_description = Potential Denial of Service attack on $dest$ - MITRE ICS - T814
action.notable.param.rule_title = OT Sec - Denial of Service
action.notable.param.security_domain = OT
action.notable.param.severity = high
action.notable.param.verbose = 0
alert.suppress = 1
alert.suppress.fields = dest,src
alert.suppress.period = 3600s
alert.track = 1
counttype = number of events
cron_schedule = */10 * * * *
description = Adversaries may perform Denial-of-Service (DoS) attacks to disrupt expected device functionality.  Some ICS devices are particularly sensitive to DoS events, and may become unresponsive in reaction to even a simple ping sweep.
disabled = 1
dispatch.earliest_time = -60m
dispatch.latest_time = now
dispatch.rt_backfill = 1
enableSched = 1
quantity = 0
realtime_schedule = 0
relation = greater than
request.ui_dispatch_app = SplunkEnterpriseSecuritySuite
search = eventtype=mitre_ics_event technique_id=T814 \
| `get_mitre_host_info_mac` \
| append \
    [ search index=notable (search_name="*Excessive DNS*" \
        OR search_name="*Large Volume of DNS ANY Queries*") \
    | lookup asset_lookup_by_str asset as dvc \
    | lookup asset_lookup_by_str asset as src \
    | lookup asset_lookup_by_str asset as dest \
    | search category="*ot*" ] \
| append \
    [| tstats summariesonly=true count from datamodel=Network_Traffic.All_Traffic by _time,All_Traffic.src,All_Traffic.dest \
    | `drop_dm_object_name("All_Traffic")` \
    | lookup asset_lookup_by_str asset as dest \
    | search `get_ot_device_asset_types(asset_type)` count > 100 \
    | eventstats stdev(count) AS stdev avg(count) AS avg p95(count) AS p95 by src,dest \
    | where count>(avg+stdev*2) \
    | eval z_score=(count-avg)/stdev ]

[OT - OT Sec - Network Connection Enumeration - Rule]
action.correlationsearch.enabled = 1
action.correlationsearch.label = OT Sec - Network Connection Enumeration
action.customsearchbuilder.enabled = false
action.customsearchbuilder.spec = {}
action.notable = 1
action.notable.param.rule_description = Network Connection Enumeration performed on $dest$ - MITRE ICS T840
action.notable.param.rule_title = OT Sec - Network Connection Enumeration
action.notable.param.security_domain = OT
action.notable.param.severity = high
action.notable.param.verbose = 0
alert.suppress = 1
alert.suppress.fields = dest
alert.suppress.period = 60s
alert.track = 1
counttype = number of events
cron_schedule = 0 * * * *
description = Adversaries may perform network connection enumeration to discover information about device communication patterns. If an adversary can inspect the state of a network connection with tools, such as netstat, in conjunction with System Firmware, then they can determine the role of certain devices on the network.
disabled = 1
dispatch.earliest_time = -70min@min
dispatch.latest_time = -10m@m
dispatch.rt_backfill = 1
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = SplunkEnterpriseSecuritySuite
search = eventtype=mitre_ics_event technique_id=T840 \
| `get_mitre_host_info_mac` \
| append \
    [ search index=notable search_name="*Detect processes used for System Network Configuration Discovery*" \
    | lookup ot_asset_lookup ip as dest \
    | lookup ot_asset_lookup ip as src \
    | lookup ot_asset_lookup ip as dvc \
    | fillnull dest_category, src_category, dvc_category value="NA" \
    | search dest_category="*ot*" OR src_category="*ot*" OR dvc_category="*ot*" ]

[OT - OT Sec - Theft of Operational Information - Rule]
action.correlationsearch.enabled = 1
action.correlationsearch.label = OT Sec - Theft of Operational Information
action.customsearchbuilder.enabled = false
action.customsearchbuilder.spec = {}
action.notable = 1
action.notable.param.rule_description = Potential Theft of Operation Information on $src$ detected - MITRE ICS - T882
action.notable.param.rule_title = OT Sec - Theft of Operational Information
action.notable.param.security_domain = OT
action.notable.param.severity = low
action.notable.param.verbose = 0
alert.suppress = 1
alert.suppress.fields = user,src,dest,signature
alert.suppress.period = 3600s
alert.track = 1
counttype = number of events
cron_schedule = 15 */1 * * *
description = Adversaries may steal operational information on a production environment as a direct mission outcome for personal gain or to inform future operations. This information may include design documents, schedules, rotational data, or similar artifacts that provide insight on operations.
disabled = 1
dispatch.earliest_time = -24h
dispatch.latest_time = now
dispatch.rt_backfill = 1
enableSched = 1
quantity = 0
realtime_schedule = 0
relation = greater than
request.ui_dispatch_app = SplunkEnterpriseSecuritySuite
search = eventtype=mitre_ics_event technique_id=T882 \
| `get_mitre_host_info_mac` \
| append \
    [ search tag=dlp tag=incident \
    | fillnull dest, src value="unknown" \
    | stats earliest(_time) as earliest latest(_time) as latest by user, signature, dest, src \
    | eval maxlatest=now() \
    | eval isOutlier=if(earliest >= relative_time(maxlatest, "-1d@d"), 1, 0) \
     | lookup asset_lookup_by_str asset as dvc \
    | lookup asset_lookup_by_str asset as src \
    | lookup asset_lookup_by_str asset as dest \
    | search category="*ot*" isOutlier=1 ]

[OT - OT Sec - Service Stop - Rule]
action.correlationsearch.enabled = 1
action.correlationsearch.label = OT Sec - Service Stop
action.customsearchbuilder.enabled = false
action.customsearchbuilder.spec = {}
action.notable = 1
action.notable.param.rule_description = Critical Service Stop of $service_name$ on $dest$ detected - MITRE ICS T881
action.notable.param.rule_title = OT Sec - Service Stop
action.notable.param.security_domain = OT
action.notable.param.severity = high
action.notable.param.verbose = 0
alert.suppress = 1
alert.suppress.fields = service_name,dest,dvc
alert.suppress.period = 3600s
alert.track = 1
counttype = number of events
cron_schedule = */15 * * * *
description = Adversaries may stop or disable services on a system to render those services unavailable to legitimate users. Stopping critical services can inhibit or stop response to an incident or aid in the adversary's overall objectives to cause damage to the environment.  \
Critical services are defined in critical_ot_services.csv file
dispatch.earliest_time = -15m
dispatch.latest_time = now
dispatch.rt_backfill = 1
enableSched = 1
quantity = 0
realtime_schedule = 0
relation = greater than
request.ui_dispatch_app = SplunkEnterpriseSecuritySuite
search = eventtype=mitre_ics_event technique_id=T881 \
| `get_mitre_host_info_mac` \
| append \
    [ search (source="WinEventLog:System" sourcetype=xmlwineventlog) OR (sourcetype=wineventlog source="WinEventLog:System") EventCode=7036 OR EventCode=7040 \
    | rex field=Message "The (start type of the )*(?<service_name>.*) (service ){1}" \
    | eval service_name=if(isnull(param1), service_name, param1) \
    | eval ComputerName=if(isnull(ComputerName), Computer, ComputerName) \
    | lookup critical_ot_services service_name OUTPUT host_names \
    | makemv delim="|" host_names \
    | mvexpand host_names \
    | where ComputerName=host_names \
    | rename ComputerName as dest, dvc as host ]

[Threat - OT Sec - MITRE ICS Alert - Rule]
action.correlationsearch.enabled = 1
action.correlationsearch.label = OT Sec - MITRE ICS Alert
action.customsearchbuilder.spec = {}
action.keyindicator.invert = 0
action.makestreams.param.verbose = 0
action.nbtstat.param.verbose = 0
action.notable = 1
action.notable.param.extract_artifacts = {"asset":["src","dest","dvc"],"identity":["src_user","user","src_user_id","src_user_role","user_id","user_role","vendor_account"]}
action.notable.param.recommended_actions = email
action.notable.param.rule_description = An indicator of a MITRE ICS Attack was detected.  See alert message for details on the specific attack
action.notable.param.rule_title = $alert_message$
action.notable.param.security_domain = OT
action.notable.param.severity = high
action.notable.param.verbose = 0
action.nslookup.param.verbose = 0
action.ping.param.verbose = 0
action.risk.param.verbose = 0
action.send2uba.param.verbose = 0
action.threat_add.param.verbose = 0
alert.suppress = 1
alert.suppress.fields = src,dest
alert.suppress.period = 10800s
alert.track = 1
counttype = number of events
cron_schedule = */5 * * * *
description = This alert is designed to catch all MITRE ICS ATT&CK alerts received from any solution with the appropriate technique_id.  This is generic alert.
dispatch.earliest_time = -15min
dispatch.latest_time = now
dispatch.rt_backfill = 1
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = SplunkEnterpriseSecuritySuite
search = `get_ot_security_alerts` technique_id=*\
| `get_mitre_host_info_mac` \
| eval source_message=if(src="unknown", " by " + host, " on " + src) \
| eval alert_message=technique_name + " activity detected ("+ technique_id + " - " + tactic_name + ")" + source_message + " (MITRE ICS)"


